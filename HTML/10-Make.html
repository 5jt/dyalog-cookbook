<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">
<title>Make</title>
<style media="screen">
html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;}body{margin:0;}article,aside,footer,header,nav,section{display:block;}h1{font-size:2em;margin:0.67em 0;}figcaption,figure,main{display:block;}figure{margin:1em 40px;}hr{box-sizing:content-box;height:0;overflow:visible;}pre{font-family:monospace, monospace;font-size:1em;}a{background-color:transparent;-webkit-text-decoration-skip:objects;}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted;}b,strong{font-weight:inherit;}b,strong{font-weight:bolder;}code,kbd,samp{font-family:monospace, monospace;font-size:1em;}dfn{font-style:italic;}mark{background-color:#ff0;color:#000;}small{font-size:0.8em;}sub,sup{font-size:0.75em;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}audio,video{display:inline-block;}audio:not([controls]){display:none;height:0;}img{border-style:none;}svg:not(:root){overflow:hidden;}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:1em;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button,html [type="button"], [type="reset"],[type="submit"]{-webkit-appearance:button;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{display:inline-block;vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details, menu{display:block;}summary{display:list-item;}canvas{display:inline-block;}template{display:none;}[hidden]{display:none;}body{margin:0;font-family:"Bookman Old Style", "Callisto MT", Bookman, "Goudy Old Style", Garamond, serif;background-color:#fdfdfd;font-size:18px;line-height:1.4;max-width:none;padding:0.83em;color:#292929;}h1, h2, h3, h4, h5, h6{color:#404040;font-weight:800;padding-left:0;}h1, h2, h3, h4, h5, h6{font-family:"Century Gothic", Verdana, "Sans";}h1, h2, h3, h4, p{margin-bottom:0.88em;}h1{font-size:1.8em;margin:0.27em 0 1.11em 0;}h1 > code, h2 > code, h3 > code, h4 > code, h5 > code, h6 > code{font-size:1em;background-color:inherit;}h2{font-size:1.44em;margin:0.55em 0 0.55em 0;padding-top:0.55em;border-bottom:1px solid Silver;}h3{margin:0;margin-top:0.55em;font-size:1.22em;}nav h3{font-size:0.88em;margin-left:0.83em;margin-bottom:0.27em;}h4{font-size:1em;margin:0;margin-top:0.55em;}h5{font-size:0.94em;margin:0;margin-top:0.66em;padding:0;}h6{font-size:0.88em;margin:0;margin-top:0.66em;padding:0;}a{color:#0099ff;margin:0;padding:0;vertical-align:baseline;}a:visited{color:purple;}a.autoheader_anchor{text-decoration:none;}ul{list-style-type:disc;}ul, ol{padding:0;margin:0;}dd{padding-top:0.25em;}p.first_dd{padding-top:0.25em;}li > ul, ol{padding-bottom:0;}li{line-height:1.3;margin-left:1.38em;margin-bottom:0.55em;}ul > li{margin-left:1.11em;}li ul{margin-left:0.55em;}li ul{margin-left:0.27em;}li p{padding:1px 0 0 0;margin:0.55em 0 0.27em 0;line-height:1.3;}p, ul, ol{line-height:1.3;padding:0.44em 0 0 0;margin:0;}pre{overflow:scroll;padding:0.55em 0.27em;margin:0.55em 0 0.55em 0 !important;background-color:#faebd7;color:#3e3e3e;border:1px Silver dashed;display:block;font-family:APLFont, monospace;font-weight:400;}pre > code{line-height:1.2;border:0;padding:0;margin:0;background-color:inherit;color:inherit;font-weight:inherit;}a code{padding:0;font-size:1em;}nav code{background-color:inherit;font-weight:400;color:inherit;}code{font-family:APLFont, monospace;background-color:#e7e7e7;color:Black;font-weight:800;line-height:1.2;font-size:0.88em;margin:0;color:#950000;padding:0 0.16em;}tbody tr:nth-child(even){background-color:#F0F0F0;}th{background-color:#E6E6E6;color:black;}th, td{padding:0.16em 0.55em;}table{border-color:Black;margin:1.11em 0 1.11em 0;border:2px black;border-collapse:collapse;font-family:APLFont;font-size:0.88em;line-height:1.2;border:1px solid Gray;}li > table{margin:0.55em 0 0.55em 0;}tr{margin:1.11em;}th{font-weight:bold;}tfoot td{font-weight:bold;}blockquote{border-left:0.27em solid silver;padding-left:0.27em;margin:0.83em 0.27em 0.83em 0.55em;}blockquote ul li{margin-left:1.38em;}blockquote ol li{margin-left:1.38em;}li > blockquote{margin-left:0;}nav{background-color:#f5f5f5;border:1px solid Black;padding:0.55em;margin:0.55em;margin-right:0;box-shadow:0.27em 0.27em 0.27em Gray;overflow:hidden;}nav#main_nav{position:fixed;top:0;right:0.55em;float:none;width:auto;}nav#main_nav_no_collapse li{font-size:0.77rem;}nav#main_nav_no_collapse li{line-height:1.5;}nav ul{list-style-type:none;margin:0 0 0.11em 0;padding:0;}nav a:visited{color:black;}nav ul li{margin-bottom:0.16em;}nav li p{margin:0;padding:0;line-height:1;margin:0;padding:0;}nav li{font-size:0.75rem;line-height:1.3;padding:0;margin-top:0;margin-bottom:0;margin-left:0.83em;}nav p{font-weight:bold;font-size:0.75rem;padding-top:0;}dl{margin-top:0.1em;margin-bottom:0.1em;}dt{margin-top:0.75em;margin-bottom:0.1em;font-weight:800;}label#hide_toc_label{font-size:0.8em;}.toc-container{position:relative;height:auto;}div.toc-container h1{font-size:0.88em;margin:0.27em 0 0.27em 0;}[type="checkbox"]{position:absolute;left:-9999px;}label{display:block;width:100%;height:1.1em;cursor:pointer;top:0;padding-left:1.1em;}label:before{content:'Table of contents \25BC';font-weight:bold;font-size:90%;padding-bottom:0;}[type="checkbox"] ~ div{display:none;}[type="checkbox"]:checked ~ div{display:block;margin-top:1.1em;}[type="checkbox"]:checked + label{top:100%;}[type="checkbox"]:checked + label:before{content:'Table of contents â–²';}div#footnotes_div p{line-height:1;padding-bottom:0;padding-top:0;}div#footnotes_div ol{padding-top:0;}@font-face{font-family:"APLFont";src:local("APL385 Unicode"), url("http://misc.aplteam.com/apl385.ttf") format("truetype");}.no_display{display:none;}.red{color:red;}img{margin-top:0.55em;margin-bottom:0.27em;}div.leanpub{padding:0.83em 0.55em 1.11em 0;margin:0.55em 0 0 0.27em;overflow:auto;}div.leanpub_A{border:1px solid black;background-color:#f1f1f1;padding:0.55em;margin:1.11em 0 0.83em 0;}div.leanpub h3, div.leanpub_A h3{font-size:1.2em;padding:0;margin:0;}div.leanpub h4, div.leanpub_A h4{font-size:1.1em;padding:0.27em 0 0 0;margin:0;}div.leanpub h5, div.leanpub h5{font-size:1.0em;padding:0.27em 0 0 0;margin:0;}div.leanpub_A h5, div.leanpub_A h5{font-size:1.0em;padding:0.27em 0 0 0;margin:0;}div.leanpub img{padding:0;margin:0 1.11em 0.27em 0;}div.leanpub_A > p:first-child{padding-top:0;margin-top:0;}div.leanpub img{float:left;padding:0;margin:0.55em 1.11em 0 0;clear:both;}div.leanpub tbody *{background-color:transparent;}div.leanpub p{padding:0.17em 0 0 0;margin:0;}span.leanpub_code{color:Red;}div.leanpub p{display:block;padding:0.44em 0 0 0;}div.leanpub > div{margin-left:2.27em;}
</style>
<style media="print">
@page{margin:25mm 20mm 25mm 20mm;}body{font-family:"Bookman Old Style", "Callisto MT", Bookman,"Goudy Old Style", Garamond, serif;font-size:9pt;line-height:1.2;}h1{font-size:170%;}h2{font-size:110%;}h3{font-size:110%;}h4{font-size:105%;}h5{font-size:100%;}h6{font-size:95%;}h1{margin:0 0 20pt 0;}h2{margin:15pt 0 3pt 0;}h3{margin:10pt 0 0pt 0;}h4{margin:10pt 0 0pt 0;}h5{margin:9pt 0 0pt 0;}h6{margin:9pt 0 0pt 0;}h1, h2, h3, h4, h5, h6{color:black;font-family:"Century Gothic", Verdana, "Sans";page-break-after:avoid;}h1 > code, h2 > code, h3 > code, h4 > code, h5 > code, h6 > code{font-size:100%;}h2{border-bottom:1pt solid Silver;padding-bottom:2pt;}.h_tag{page-break-after:avoid;break-after:avoid;}abbr[title]{border-bottom:0;text-decoration:none;}a{color:black;margin:0;padding:0;vertical-align:baseline;text-decoration:none;font-style:italic;}a.autoheader_anchor{text-decoration:none;font-style:normal;page-break-after:avoid;break-after:avoid;}ul{list-style-type:square;}ul, ol{padding:0;margin:0;}li > ul, ol{padding-bottom:0;}li{line-height:1.3;margin-left:13pt;margin-bottom:5pt;}ul > li{margin-left:10pt;}li ul{margin-left:5pt;}li ul{margin-left:3pt;}li p{padding:1pt 0 0 0;margin:5pt 0 3pt 0;line-height:1.3;}p, ul, ol{line-height:1.3;padding:4pt 0 0 0;margin:0;color:black;}pre{padding:3pt;margin:5pt 0;white-space:pre-wrap;background-color:#FAFAFA;border:1pt Silver solid;display:block;font-family:APLFont, monospace;page-break-inside:avoid;-webkit-print-color-adjust:exact;}pre code{background-color:#FAFAFA;color:Black;padding:0;margin:0 0 -6pt 0;line-height:1.1;border:0;}code{font-family:APLFont, monospace;line-height:1.2;font-size:9pt;padding:3pt 1pt 3pt 1pt;color:#950000;padding:3pt 4pt 3pt 4pt;}tbody th, tfoot tr{background-color:#e6e6e6;}tbody tr:nth-child(even){background-color:#fafafa;}th{background-color:#F0F0F0;}th, td{padding:1pt 5pt;}table{margin:10pt 0;font-family:APLFont;font-size:9pt;padding:0;border:1pt solid silver;-webkit-print-color-adjust:exact;}li > table{margin:10pt 0 10pt 0;}tr{margin:20pt;}th{font-weight:bold;}tfoot td{font-weight:bold;}blockquote{border-left:5pt solid silver;padding-left:5pt;margin:8pt 3pt 8pt 8pt;}nav{background-color:#f8f8f8;border:1pt solid Gray;width:auto;float:right;padding:5pt 5pt 5pt 0;margin:5pt 0 5pt 5pt;page-break-inside:avoid;}nav *{font-size:75%;}nav ul{list-style-type:none;margin:0 0 2pt 0;padding:0;}nav ul li{margin-bottom:0;}nav li p{margin:0;padding:0;line-height:1;margin:0;padding:0;}nav li{font-size:9pt;line-height:1;padding:0;margin-top:0;margin-bottom:0;margin-left:8pt;}dl{margin-top:0;margin-bottom:10pt;}dt{margin-top:10pt;margin-bottom:0;font-weight:800;page-break-inside:avoid;}dd{margin-top:2pt;}label#hide_toc_label{font-size:65%;}.toc-container{position:relative;height:auto;margin-top:5pt;}.toc-container h1{margin:0 0 7pt 7pt;}[type="checkbox"]{display:none;}label{display:block;width:100%;height:1.1em;top:0;padding-left:10pt;}label:before{content:'Table of contents';font-weight:bold;font-size:140%;padding-bottom:10pt;}a.external_link::before{content:" ğŸŒ";}a.bookmark_link::before{content:" â¯";}a.mailto_link::before{content:" âœ‰"}nav a.bookmark_link{font-style:normal;}nav p{margin-left:10pt;font-weight:bold;font-size:9pt;}nav a{font-style:normal;}nav a.bookmark_link::before{content:"";}div#footnotes_div a::before{content:"";}div#footnotes_div a{font-style:normal;}div#footnotes_div{page-break-inside:avoid;}@font-face{font-family:"APLFont";src:local("APL385 Unicode"), url("http://misc.aplteam.com/apl385.ttf") format("truetype");}.no_print{display:none;}.red{color:red;}.avoid_page_break{page-break-inside:avoid;}.page_break_before{page-break-before:auto;}div.leanpub{margin:10pt 0 10pt 8pt;page-break-inside:avoid;}div.leanpub_A{border:1pt solid black;background-color:#f9f9f9;padding:5pt;margin:10pt 0 10pt 0;page-break-inside:avoid;}div.leanpub h3, div.leanpub_A h3{font-size:1.2em;padding:3pt 0 0 0;margin:0;}div.leanpub h4, div.leanpub_A h4{font-size:1.1em;padding:3pt 0 0 0;margin:0;}div.leanpub h5, div.leanpub h5{font-size:1.0em;padding:3pt 0 0 0;margin:0;}div.leanpub_A h5, div.leanpub_A h5{font-size:1.0em;padding:3pt 0 0 0;margin:0;}div.leanpub img{padding:0;margin:0 10pt 2pt 0;}div.leanpub_A > p:first-child{padding-top:0;margin-top:0;}div.leanpub > div > h1:first-child{padding-top:5pt;}div.leanpub img{float:left;padding:0;margin:5pt 10pt 0 0;clear:both;}div.leanpub p{padding:3pt 0 0 0;margin:0;}span.leanpub_code{color:black;}div.leanpub p{display:block;padding:8pt 0 0 0;}div.leanpub > div{margin-left:35pt;}
</style>
<meta name="author" content="kai">
</head>
<body>
<nav id="main_nav_no_collapse">
<div class="toc-container">
<h3>Table of contents</h3>
<ul>
<li><a href="#The-development-environment">The development environment</a>
<ul>
<li><a href="#Development-helpers">Development helpers</a></li>
<li><a href="#Running-test-cases-first-thing-in-the-morning">Running test cases first thing in the morning</a></li>
</ul></li>
<li><a href="#MyAppdyalog">MyApp.dyalog</a></li>
<li><a href="#Make-the-application">Make the application</a>
<ul>
<li><a href="#Batch-file-for-starting-Dyalog">Batch file for starting Dyalog</a></li>
<li><a href="#The-DYAPP-file">The DYAPP file</a></li>
<li><a href="#Assertions">Assertions</a></li>
<li><a href="#INI-files">INI files</a></li>
<li><a href="#Prerequisites">Prerequisites</a>
<ul>
<li><a href="#Bind-types">Bind types</a></li>
<li><a href="#Flags">Flags</a></li>
</ul></li>
<li><a href="#Exporting">Exporting</a></li>
<li><a href="#Check-the-result">Check the result</a></li>
</ul></li>
<li><a href="#The-tests">The tests</a></li>
<li><a href="#Workflow">Workflow</a>
</ul>
</div>
</nav>
<div class="h_tag">
<a href="#Make-me" id="Make-me" class="autoheader_anchor">
<h1>Make me</h1>
</a>
</div>
<p>Itâ€™s time to take a closer look at the process of building the application workspace and exporting the <abbr title="Executable file with the extension 'exe'">EXE</abbr>. In this chapter weâ€™ll</p>
<ul>
<li>add the automated execution of test cases to the <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr></li>
<li>create a Make utility that allows us to create everything that's finally shipped to the customer</li>
</ul>
<p>At first glance you might think all we need are two versions of the <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr>, one for development and one for producing the <abbr title="Executable file with the extension 'exe'">EXE</abbr>, but there will be tasks we cannot carry out with this approach. Examples are:</p>
<ul>
<li>On our development machine DYAPPs are associated (in the Windows Registry) with a single version of Dyalog. We need a way to control which version that is, even if at this point there is just one version installed on our machine.</li>
<li>We might want to convert any Markdown documents â€“ like README.<abbr title="File with the extension 'md' that contains markdown">MD</abbr> â€“ into <abbr title="Hyper Text Mark-up language">HTML</abbr> documents. While the <abbr title="File with the extension 'md' that contains markdown">MD</abbr> is the source, only the <abbr title="Hyper Text Mark-up language">HTML</abbr> will be shipped.</li>
<li>We need to ensure the Help system â€“ which we will introduce soon â€“ is properly compiled and configured by the Make utility.</li>
<li>Soon we shall need an installer that produces an <abbr title="Executable file with the extension 'exe'">EXE</abbr> we can send to the customer for installing the software.</li>
</ul>
<p>We resume, as usual, by saving a copy of <code>Z:\code\v09</code> as <code>Z:\code\v10</code>. Now delete <code>MyApp.exe</code> from <code>Z:\code\v10</code>: from now on we will create the <abbr title="Executable file with the extension 'exe'">EXE</abbr> somewhere else.</p>
<div class="h_tag">
<a href="#The-development-environment" id="The-development-environment" class="autoheader_anchor">
<h2>The development environment</h2>
</a>
</div>
<p><code>MyApp.dyapp</code> does not need many changes, it comes with everything needed for development. The only thing we add is to execute the test cases automatically. Almost automatically.</p>
<p>In an ideal world we would ensure all test cases pass before the end of each working day. But sometimes that is just not possible, due to the amount of work involved.</p>
<p>In such cases it might be sensible to execute the test cases before you <em>start</em> working: if you <em>know</em> they will fail and there are <em>many</em> of them there is no point in wasting computer resource and your time; better ask.</p>
<div class="h_tag">
<a href="#Development-helpers" id="Development-helpers" class="autoheader_anchor">
<h3>Development helpers</h3>
</a>
</div>
<p>For that we are going to have a function <code>YesOrNo</code>, very simple and straightforward. Its right argument (<code>question</code>) is printed to the session and then the user might answer that question.</p>
<p>If she does not enter one of: â€œYyNnâ€ the question is repeated. If she enters one of â€œYyâ€ a 1 is returned, otherwise a 0. Since we use this to ask ourself (or other programmers) the function does not have to be bulletproof; we just use <code>Â¯1â†‘â</code>.</p>
<p>But where exactly should this function go? Though it is helpful it has no part in our final application. Therefore we put it into a new script called <code>DevHelpers</code>. We also add a function <code>RunTests</code> to this new script:</p>
<pre><code>:Namespace DevHelpers

âˆ‡ {r}â†RunTests forceFlag
â Runs the test cases in debug mode, either in case the user wants to
â or if `forceFlag` is 1.
  râ†''
  :If forceFlag
  :OrIf YesOrNo'Would you like to execute all test cases in debug mode?'
      râ†#.Tests.RunDebug 0
  :EndIf
âˆ‡

âˆ‡ flagâ†YesOrNo question;isOkay;answer
  isOkayâ†0
  â•â†(â•PW-1)â´'-'
  :Repeat
      ââ†question,' (y/n) '
      answerâ†Â¯1â†‘â
      :If answerâˆŠ'YyNn'
          isOkayâ†1
          flagâ†answerâˆŠ'Yy'
      :EndIf
  :Until isOkay
âˆ‡

:EndNamespace</code></pre>
<div class="h_tag">
<a href="#Running-test-cases-first-thing-in-the-morning" id="Running-test-cases-first-thing-in-the-morning" class="autoheader_anchor">
<h3>Running test cases first thing in the morning</h3>
</a>
</div>
<p>We add a line to the bottom of <code>MyApp.dyapp</code>:</p>
<pre><code>...
Run #.Tester.EstablishHelpersIn #.Tests
<span class="leanpub_code">Run #.DevHelpers.RunTests 0
</span></code></pre>
<p>Now a developer who double-clicks the <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr> in order to assemble the workspace will always be reminded of running all test cases before she starts working on the application. Experience tells us that this is a good thing.</p>
<div class="h_tag">
<a href="#MyAppdyalog" id="MyAppdyalog" class="autoheader_anchor">
<h2>MyApp.dyalog</h2>
</a>
</div>
<p>One minor thing needs our attention: because we create <code>MyApp.exe</code> now in a folder <code>MyApp</code>, simply setting <code>â•WSID</code> to <code>MyApp</code> does not do anymore. We need to make a change to the <code>StartFromCmdLine</code> function in <code>MyApp.dyalog</code>:</p>
<pre><code>...
âˆ‡ {r}â†StartFromCmdLine arg;MyLogger;Config;rc;â•TRAP
   â Needs command line parameters, runs the application.
      râ†â¬
      â•TRAPâ†#.HandleError.SetTrap â¬
      â•SIGNAL 0
<span class="leanpub_code">      â•WSIDâ†âŠƒ{âµ/â¨~'='âˆŠÂ¨âµ}{âµ/â¨'-'â‰ âŠƒÂ¨âµ}1â†“2â•nq # 'GetCommandLineArgs'
</span>      #.FilesAndDirs.PolishCurrentDir
...</code></pre>
<p>This change ensures the <code>â•WSID</code> will be correct. Under the current circumstances it will be <code>MyApp\MyApp.dws</code>.</p>
<p>Note that we access <code>GetCommandLineArgs</code> as a function call with <code>â•NQ</code> rather than referring to <code>#.GetCommandLineArgs</code>; over the years that has proven to be more reliable.</p>
<div class="h_tag">
<a href="#Make-the-application" id="Make-the-application" class="autoheader_anchor">
<h2>Make the application</h2>
</a>
</div>

<div class="leanpub">
<img src="https://download.aplwiki.com/LeanPub/Images/information.png" alt="Information">
<div>
<p>In most programming languages the process of compiling the source code and putting together an application is done by a utility that's called Make; we use the same term.</p>
</div>
</div>

<p>At first sight it might seem all we need is a reduced version of <code>MyApp.dyapp</code>, but not so. Soon we will discuss how to add a Help system to our application.</p>
<p>We must then make sure that the Help system is compiled properly when the application is assembled. Later, more tasks will come up. Conclusion: our Make file cannot be a <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr>; we need more flexibility.</p>

<div class="leanpub_A">
<h3>More complex scenarios</h3>
<p>In a more complex application than ours you might prefer a different approach. Using an <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> file for this is not a bad idea: it gives you scope to define more than just the modules to be loaded, and some code to execute.</p>
<p>Also, if you have not one but several applications to support, it is useful to implement your own generalised user command like <code>]runmake</code>.</p>
</div>

<p><code>Execute</code>, <code>Tester</code> and <code>Tests</code> have no place in the finished application, nor do we need the test helpers either.</p>
<div class="h_tag">
<a href="#Batch-file-for-starting-Dyalog" id="Batch-file-for-starting-Dyalog" class="autoheader_anchor">
<h3>Batch file for starting Dyalog</h3>
</a>
</div>
<p>For now, weâ€™ll create a <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr> file <code>Make.dyapp</code> that performs the Make.</p>
<p>However, if you want to specify explicitly the version of Dyalog that should run this <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr> rather than using whichever version happens to be associated with the file extension <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr> at the time you double-click it, (also <abbr title="Dyalog workspace">DWS</abbr> and <abbr title="File with the extension 'dyalog' holding APL code">DYALOG</abbr>) you need a batch file that starts the correct version of Dyalog.</p>
<p>Create such a batch file as <code>Make.bat</code>:</p>
<pre><code>"C:\Program Files\Dyalog\Dyalog APL{yourPreferredVersion}\Dyalog.exe" DYAPP="%~dp0Make.dyapp"
@echo off
if NOT ["%errorlevel%"]==["0"] (
    echo Error %errorlevel%
    pause
    exit /b %errorlevel%
)</code></pre>
<p>Edit to use your chosen Dyalog version of your choice. You can see the version currently associated on your machine:</p>
<pre><code>'"',(âŠƒ#.GetCommandLineArgs),'"'</code></pre>
<p>You might want to add other parameters like <code>MAXWS=128M</code> (or <code>MAXWS=6G</code>) to the <abbr title="Executable file that contains batch commands">BAT</abbr>.</p>
<p>Notes:</p>
<ul>
<li>The expression <code>%~dp0</code> in a batch file will give you the full path â€“ with a trailing <code>\</code> â€“ of the folder that hosts the batch file. In other words, <code>"%~dp0Make.dyapp"</code> would result in a full path pointing to <code>MyApp.dyapp</code>, no matter where that is as long as it is a sibling of the <abbr title="Executable file that contains batch commands">BAT</abbr> file.
<p>You <em>must</em> specify a full path because when the interpreter looks for the <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr>, the current directory is where the <abbr title="Executable file with the extension 'exe'">EXE</abbr> lives, <em>not</em> where the <abbr title="Executable file that contains batch commands">BAT</abbr> file lives.</p></li>
<li>Checking <code>errorlevel</code> ensures that, in case of an error, the batch file shows the return code and then pauses.
<p>That gets us around the problem that when you double-click a <abbr title="Executable file that contains batch commands">BAT</abbr> file, you see a black windows popping up for a split of a second, leaving you wondering whether it succeeded.</p>
<p>Now if an error occurs, the script will pause. And it will pass the value of <code>errorlevel</code> as its return code.</p>
<p>However, this technique suits only scripts to be executed by a WCU [<a href="#fnref1" class="footnote_link"><sup>1</sup></a>]; you donâ€™t want a pause in scripts called by other scripts.</p></li>
</ul>
<div class="h_tag">
<a href="#The-DYAPP-file" id="The-DYAPP-file" class="autoheader_anchor">
<h3>The DYAPP file</h3>
</a>
</div>
<p>Now we need to establish the <code>Make.dyapp</code> file:</p>
<pre><code>Target #
Load ..\AplTree\APLTreeUtils
Load ..\AplTree\FilesAndDirs
Load ..\AplTree\HandleError
Load ..\AplTree\IniFiles
Load ..\AplTree\OS
Load ..\AplTree\Logger
Load Constants
Load Utilities
Load MyApp
Run #.MyApp.SetLX â¬

Load Make
Run #.Make.Run 1</code></pre>
<p>The upper part (until the blank line) is identical with <code>MyApp.dyapp</code>, without the stuff thatâ€™s needed only during development. We then load a script <code>Make</code> and finally we call <code>Make.Run</code>. Hereâ€™s <code>Make</code> at this point:</p>
<pre><code>:Class Make
â Puts the application `MyApp` together:
â 1. Remove folder `DESTINATION\` in the current directory
â 2. Create folder `DESTINATION\` in the current directory
â 3. Copy icon to `DESTINATION\`
â 4. Copy the INI file template over to `DESTINATION`
â 5. Creates `MyApp.exe` within `DESTINATION\`
    â•IOâ†1 â‹„ â•MLâ†1

    DESTINATIONâ†'MyApp'

    âˆ‡ {filename}â†Run offFlag;rc;en;more;successFlag;F;U;msg
      :Access Public Shared
      Fâ†##.FilesAndDirs â‹„ Uâ†##.Utilities
      (rc en more)â†F.RmDir DESTINATION
      U.Assert 0=rc
      successFlagâ†'Create!'F.CheckPath DESTINATION
      U.Assert successFlag
      (successFlag more)â†2â†‘'images'F.CopyTree DESTINATION,'\images'
      U.Assert successFlag
      (rc more)â†'MyApp.ini.template'F.CopyTo DESTINATION,'\MyApp.ini'
      U.Assert 0=rc
      Export'MyApp.exe'
      filenameâ†DESTINATION,'\MyApp.exe'
      :If offFlag
          â•OFF
      :EndIf
      âˆ‡
:EndClass</code></pre>
<div class="h_tag">
<a href="#Assertions" id="Assertions" class="autoheader_anchor">
<h3>Assertions</h3>
</a>
</div>
<p>It is common practice in any programming language to inject checks into the code to throw an error if necessary conditions are not met.</p>
<p>Letâ€™s define a function <code>Assert</code> in <code>Utilities</code>:</p>
<pre><code>:Namespace Utilities
      mapâ†{
          (,2)â‰¢â´âº:'Left argument is not a two-element vector'â•SIGNAL 5
          (old new)â†âº
          nwâ†âˆªâµ
          (new,nw)[(old,nw)â³âµ]
      }
<span class="leanpub_code">       Assertâ†{âºâ†'' â‹„ (success errorNo)â†2â†‘âµ,11 â‹„ (,1)â‰¡,success:râ†1 â‹„ âº â•SIGNAL errorNo}
</span>:EndNamespace</code></pre>
<p>Notes:</p>
<ul>
<li>The right argument of <code>Assert</code> is a scalar or vector of length 1 or 2.
<ul>
<li>The first element is a boolean: 1 for success</li>
<li>The second element is the integer error number to signal; it defaults to 11 (DOMAIN ERROR)</li>
</ul></li>
<li>The optional left argument is a left argument to <code>â•SIGNAL</code>.</li>
<li>If the right argument is any â€˜flavourâ€™ of <code>1</code> (scalar, vector, matrix, â€¦) <code>Assert</code> returns a (shy!) result <code>1</code>.</li>
<li>In all other cases <code>Assert</code> signals <code>errorNo</code> with the message specified in the left argument, if any.</li>
</ul>
<p>Because itâ€™s a one-liner you cannot trace into <code>Assert</code>. Thatâ€™s a good thing.</p>
<p>This is an easy way to make the calling function stop when something goes wrong. There is no point in doing anything but stopping the code from continuing since it is called by a programmer. When it fails you want to investigate straight away.</p>
<p>And things <em>can</em> go wrong quite easily. For example, removing <code>DESTINATION</code> might fail simply because another user is looking into <code>DESTINATION</code> with Windows Explorer.</p>
<p>First we create the folder <code>DESTINATION</code> from scratch and then we copy everything thatâ€™s needed to the folder <code>DESTINATION</code>: the application icon and the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> file. Whether the function executes <code>â•OFF</code> or not depends on the right argument <code>offFlag</code>. Why that is needed will become apparent soon.</p>
<div class="h_tag">
<a href="#INI-files" id="INI-files" class="autoheader_anchor">
<h3>INI files</h3>
</a>
</div>
<p>We donâ€™t copy <code>MyApp.ini</code> into <code>DESTINATION</code> but <code>MyApp.ini.template</code>; therefore we must create this file: copy <code>MyApp.ini</code> to <code>MyApp.ini.template</code> and then check its settings: in particular these settings are important:</p>
<pre><code>...
[Config]
Debug       = Â¯1   ; 0=enfore error trapping; 1=prevent error trapping;
Trap        = 1    ; 0 disables any :Trap statements (local traps)
ForceError  = 0    ; 1=let TxtToCsv crash (for testing global trap handling)
...
[Ride]
Active      = 0
...</code></pre>
<p>Those might well get changed in <code>MyApp.ini</code> while working on the project, so we make sure that we get them set correctly in <code>MyApp.ini.template</code>.</p>
<p>However, that leaves us open to another problem. Suppose we introduce a new section and/or a new key and forget to copy it over to the template. To prevent this we add a test case to <code>Tests</code>:</p>
<pre><code>    âˆ‡ Râ†Test_misc_01(stopFlag batchFlag);â•TRAP;ini1;ini2
      â Check if MyApp.ini &amp; MyApp.ini.template have same sections &amp; keys
      â•TRAPâ†(999 'C' '. â Deliberate error')(0 'N')
      Râ†âˆ†Failed
      ini1â†â•NEW ##.IniFiles(,âŠ‚'MyApp.ini')
      ini2â†â•NEW ##.IniFiles(,âŠ‚'MyApp.ini.template')
      â†’PassesIf ini1.GetSections{(âˆ§/âºâˆŠâµ)âˆ§(âˆ§/âµâˆŠâº)}ini2.GetSections
      â†’PassesIf(ini1.Get â¬ â¬)[;2]{(âˆ§/âºâˆŠâµ)âˆ§(âˆ§/âµâˆŠâº)}(ini2.Get â¬ â¬)[;2]
      Râ†âˆ†OK
    âˆ‡</code></pre>
<p>The test simply checks whether the two <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> files have the same sections and the same keys; that will alert us if we forget something.</p>
<div class="h_tag">
<a href="#Prerequisites" id="Prerequisites" class="autoheader_anchor">
<h3>Prerequisites</h3>
</a>
</div>
<div class="h_tag">
<a href="#Bind-types" id="Bind-types" class="autoheader_anchor">
<h4>Bind types</h4>
</a>
</div>
<p>For the <em>Bind</em> method we can specify different types. We add them to the <code>Constants</code> namespace, in their own subspace:</p>
<pre><code>:Namespace Constants
...
    :EndNamespace
<span class="leanpub_code">    :Namespace BIND_TYPES
        ActiveXControlâ†'ActiveXControl'
        InProcessServerâ†'InProcessServer'
        Libraryâ†'Library'
        NativeExeâ†'NativeExe'
        OutOfProcessServerâ†'OutOfProcessServer'
        StandaloneNativeExeâ†'StandaloneNativeExe'
    :EndNamespace
</span>:EndNamespace</code></pre>
<p>Why do this? By listing all available options, it makes the code self-explanatory.</p>
<div class="h_tag">
<a href="#Flags" id="Flags" class="autoheader_anchor">
<h4>Flags</h4>
</a>
</div>
<pre><code>:Namespace Constants
...
    :EndNamespace
<span class="leanpub_code">    :Namespace BIND_FLAGS
        BOUND_CONSOLEâ†2
        BOUND_USEDOTNETâ†4
        RUNTIMEâ†8
        BOUND_XPLOOKâ†32
    :EndNamespace
</span>:EndNamespace</code></pre>
<div class="h_tag">
<a href="#Exporting" id="Exporting" class="autoheader_anchor">
<h3>Exporting</h3>
</a>
</div>
<p><code>Run</code> then calls <code>Export</code>, a new private function in the <code>Make</code> class:</p>
<pre><code>...
    âˆ‡ {r}â†{flags}Export exeName;type;flags;resource;icon;cmdline;try;max;success;details;fn
    â Attempts to export the application
      râ†â¬
      flagsâ†##.Constants.BIND_FLAGS.RUNTIME{âºâ†0 â‹„ 0&lt;â•NC âµ:ââµ â‹„ âº}'flags'
      maxâ†50
      typeâ†##.Constants.BIND_TYPES.StandaloneNativeExe
      iconâ†F.NormalizePath DESTINATION,'\images\logo.ico'
      resourceâ†cmdlineâ†''
      detailsâ†''
      details,â†âŠ‚'CompanyName' 'My company'
      details,â†âŠ‚'ProductVersion'(2âŠƒ##.MyApp.Version)
      details,â†âŠ‚'LegalCopyright' 'Dyalog Ltd 2018'
      details,â†âŠ‚'ProductName' 'MyApp'
      details,â†âŠ‚'FileVersion' (2âŠƒ##.MyApp.Version)
      detailsâ†â†‘details
      successâ†tryâ†0
      fnâ†DESTINATION,'\',exeName     â filename
      :Repeat
          :Trap 11
              2 â•NQ'.' 'Bind' fn type flags resource icon cmdline details
              successâ†1
          :Else
              â•DL 0.2
          :EndTrap
      :Until successâˆ¨max&lt;tryâ†try+1
      :If 0=success
          â•â†'*** ERROR: Failed to export EXE to ',fn,' after ',(â•try),' tries.'
          . â Deliberate error; allows investigation
      :EndIf
    âˆ‡
:EndClass</code></pre>
<p><code>Export</code> automates what weâ€™ve done so far by calling the <em>Export</em> command from the <em>File</em> menu. If the <em>Bind</em> method fails, it retries up to 50 times before giving up.</p>
<p>From experience we know that, with the OS, the machine, the network, the filesystem and who knows what else, the command can fail several times before finally succeeding.</p>

<div class="leanpub">
<img src="https://download.aplwiki.com/LeanPub/Images/information.png" alt="Information">
<div>
<p>Why is there a â€œProductVersionâ€ and a â€œFileVersionâ€? No idea! On Stack Overflow this was discussed more than once, and it seems that there are very few cases when it might make sense to have them <strong>not</strong> in sync.</p>
<p>But â€œFileVersionâ€ is the more important one: the Inno installer for example (see <a href="./16-Creating-SetUp.exe.html" class="external_link">chapter 16 â€œCreating SetUp.exeâ€</a>) compares the â€œFileVersionâ€ of an already installed version with the possibly new version, and if they are not different then it won't overwrite the <abbr title="Executable file with the extension 'exe'">EXE</abbr> - you don't want that!</p>
</div>
</div>

<div class="leanpub_A">
<h3>The <code>Bind</code> method</h3>
<p>Note that for the <code>Bind</code> method to work as discussed in this chapter you must use at least version 17.0.31811.0 of Dyalog. Before that <code>Bind</code> was not an official method and did not support the <code>details</code>.</p>
</div>

<p>Double-click <code>Make.dyapp</code>: a folder <code>MyApp</code> should appear in <code>Z:\code\v10</code> with, among other files, <code>MyApp.exe</code>.</p>
<div class="h_tag">
<a href="#Check-the-result" id="Check-the-result" class="autoheader_anchor">
<h3>Check the result</h3>
</a>
</div>
<p>Open a Windows Explorer (Windows + E), navigate to the folder hosting the <abbr title="Executable file with the extension 'exe'">EXE</abbr>, right-click the <abbr title="Executable file with the extension 'exe'">EXE</abbr> and select <em>Properties</em> from the context menu, then click on the <em>Details</em> tab.</p>
<p><img src="./Images/Stand-alone-properties.png" alt="EXEs properties" title="APL Team's dots"></p>
<p>As you can see, the fields <em>File version</em>, <em>Product name</em>, <em>Product version</em> and <em>Copyright</em> hold the information we have specified.</p>

<div class="leanpub">
<img src="https://download.aplwiki.com/LeanPub/Images/warning.png" alt="Warning">
<div>
<p>Note that the names we have used are not the names used by Microsoft in the GUI. The MSDN [<a href="#fnref2" class="footnote_link"><sup>2</sup></a>] provides details.</p>
</div>
</div>

<div class="h_tag">
<a href="#The-tests" id="The-tests" class="autoheader_anchor">
<h2>The tests</h2>
</a>
</div>
<p>Now that we have a way automatically to assemble all the files required by our application we need to amend our tests. Double-click <code>MyApp.dyapp</code>. You don't need to execute the test cases right now because we are going to change them.</p>
<p>We need to make a few changes:</p>
<pre><code>:Namespace Tests
    â•IOâ†1 â‹„ â•MLâ†1
    âˆ‡ Initial;list;rc
      Uâ†##.Utilities â‹„ Fâ†##.FilesAndDirs â‹„ Aâ†##.APLTreeUtils
      âˆ†Pathâ†F.GetTempPath,'\MyApp_Tests'
      F.RmDir âˆ†Path
      'Create!'F.CheckPath âˆ†Path
      listâ†âŠƒF.Dir'..\..\texts\en\*.txt'
      rcâ†list F.CopyTo âˆ†Path,'\'
      :If ~Râ†0âˆ§.=âŠƒrc
          â•â†'Could not create ',âˆ†Path
      :EndIf
<span class="leanpub_code">      â•SE.UCMD'Load ',F.PWD,'\Make.dyalog -target=#'
      #.Make.Run 0
</span>    âˆ‡
 ...
:EndNamespace</code></pre>
<p><code>Initial</code></p>
<ul>
<li>loads the script <code>Make.dyalog</code> into <code>#</code></li>
<li>runs the function <code>Make.Run</code>; the <code>0</code> right argument tells <code>Make.Run</code> <em>not</em> to execute <code>â•OFF</code> â€“ something we would not appreciate at this stage</li>
</ul>
<div class="h_tag">
<a href="#Workflow" id="Workflow" class="autoheader_anchor">
<h2>Workflow</h2>
</a>
</div>
<p>With the two DYAPPs and the <abbr title="Executable file that contains batch commands">BAT</abbr> file, your development cycle now looks like this:</p>
<ol start="1">
<li>Launch <code>MyApp.dyapp</code> and check the test results.</li>
<li>Fix any errors and rerun <code>#.Tests.Run</code> until itâ€™s fine. If you edit the test themselves, either rerun
<pre><code>`#.Tester.EstablishHelpersIn #.Tests`</code></pre>
<p>or simply close the session and relaunch <code>MyApp.dyapp</code>.</p></li>
</ol>
<div id="footnotes_div">
<hr>
<p><strong>Footnotes</strong></p>
<ol>
<li id="fnref1"><p>Worst Case User, also known as Dumbest Assumable User (DAU).</p><a href="#fnref1" class="footnote_anchor"></a>
<li id="fnref2"><p>The <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa381058(v=vs.85).aspx" class="external_link">MSDN</a> provides more information on what names are actually recognized.</p><a href="#fnref2" class="footnote_anchor"></a>
</ol>
</div>
</body>
</html>