<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">
<title>Services</title>
<style media="screen">
html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;}body{margin:0;}article,aside,footer,header,nav,section{display:block;}h1{font-size:2em;margin:0.67em 0;}figcaption,figure,main{display:block;}figure{margin:1em 40px;}hr{box-sizing:content-box;height:0;overflow:visible;}pre{font-family:monospace, monospace;font-size:1em;}a{background-color:transparent;-webkit-text-decoration-skip:objects;}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted;}b,strong{font-weight:inherit;}b,strong{font-weight:bolder;}code,kbd,samp{font-family:monospace, monospace;font-size:1em;}dfn{font-style:italic;}mark{background-color:#ff0;color:#000;}small{font-size:0.8em;}sub,sup{font-size:0.75em;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}audio,video{display:inline-block;}audio:not([controls]){display:none;height:0;}img{border-style:none;}svg:not(:root){overflow:hidden;}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:1em;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button,html [type="button"], [type="reset"],[type="submit"]{-webkit-appearance:button;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{display:inline-block;vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details, menu{display:block;}summary{display:list-item;}canvas{display:inline-block;}template{display:none;}[hidden]{display:none;}body{margin:0;font-family:"Bookman Old Style", "Callisto MT", Bookman, "Goudy Old Style", Garamond, serif;background-color:#fdfdfd;font-size:18px;line-height:1.4;max-width:none;padding:0.83em;color:#292929;}h1, h2, h3, h4, h5, h6{color:#404040;font-weight:800;padding-left:0;}h1, h2, h3, h4, h5, h6{font-family:"Century Gothic", Verdana, "Sans";}h1, h2, h3, h4, p{margin-bottom:0.88em;}h1{font-size:1.8em;margin:0.27em 0 1.11em 0;}h1 > code, h2 > code, h3 > code, h4 > code, h5 > code, h6 > code{font-size:1em;background-color:inherit;}h2{font-size:1.44em;margin:0.55em 0 0.55em 0;padding-top:0.55em;border-bottom:1px solid Silver;}h3{margin:0;margin-top:0.55em;font-size:1.22em;}nav h3{font-size:0.88em;margin-left:0.83em;margin-bottom:0.27em;}h4{font-size:1em;margin:0;margin-top:0.55em;}h5{font-size:0.94em;margin:0;margin-top:0.66em;padding:0;}h6{font-size:0.88em;margin:0;margin-top:0.66em;padding:0;}a{color:#0099ff;margin:0;padding:0;vertical-align:baseline;}a:visited{color:purple;}a.autoheader_anchor{text-decoration:none;}ul{list-style-type:disc;}ul, ol{padding:0;margin:0;}dd{padding-top:0.25em;}p.first_dd{padding-top:0.25em;}li > ul, ol{padding-bottom:0;}li{line-height:1.3;margin-left:1.38em;margin-bottom:0.55em;}ul > li{margin-left:1.11em;}li ul{margin-left:0.55em;}li ul{margin-left:0.27em;}li p{padding:1px 0 0 0;margin:0.55em 0 0.27em 0;line-height:1.3;}p, ul, ol{line-height:1.3;padding:0.44em 0 0 0;margin:0;}pre{overflow:scroll;padding:0.55em 0.27em;margin:0.55em 0 0.55em 0 !important;background-color:#faebd7;color:#3e3e3e;border:1px Silver dashed;display:block;font-family:APLFont, monospace;font-weight:400;}pre > code{line-height:1.2;border:0;padding:0;margin:0;background-color:inherit;color:inherit;font-weight:inherit;}a code{padding:0;font-size:1em;}nav code{background-color:inherit;font-weight:400;color:inherit;}code{font-family:APLFont, monospace;background-color:#e7e7e7;color:Black;font-weight:800;line-height:1.2;font-size:0.88em;margin:0;color:#950000;padding:0 0.16em;}tbody tr:nth-child(even){background-color:#F0F0F0;}th{background-color:#E6E6E6;color:black;}th, td{padding:0.16em 0.55em;}table{border-color:Black;margin:1.11em 0 1.11em 0;border:2px black;border-collapse:collapse;font-family:APLFont;font-size:0.88em;line-height:1.2;border:1px solid Gray;}li > table{margin:0.55em 0 0.55em 0;}tr{margin:1.11em;}th{font-weight:bold;}tfoot td{font-weight:bold;}blockquote{border-left:0.27em solid silver;padding-left:0.27em;margin:0.83em 0.27em 0.83em 0.55em;}blockquote ul li{margin-left:1.38em;}blockquote ol li{margin-left:1.38em;}li > blockquote{margin-left:0;}nav{background-color:#f5f5f5;border:1px solid Black;padding:0.55em;margin:0.55em;margin-right:0;box-shadow:0.27em 0.27em 0.27em Gray;overflow:hidden;}nav#main_nav{position:fixed;top:0;right:0.55em;float:none;width:auto;}nav#main_nav_no_collapse li{font-size:0.77rem;}nav#main_nav_no_collapse li{line-height:1.5;}nav ul{list-style-type:none;margin:0 0 0.11em 0;padding:0;}nav a:visited{color:black;}nav ul li{margin-bottom:0.16em;}nav li p{margin:0;padding:0;line-height:1;margin:0;padding:0;}nav li{font-size:0.75rem;line-height:1.3;padding:0;margin-top:0;margin-bottom:0;margin-left:0.83em;}nav p{font-weight:bold;font-size:0.75rem;padding-top:0;}dl{margin-top:0.1em;margin-bottom:0.1em;}dt{margin-top:0.75em;margin-bottom:0.1em;font-weight:800;}label#hide_toc_label{font-size:0.8em;}.toc-container{position:relative;height:auto;}div.toc-container h1{font-size:0.88em;margin:0.27em 0 0.27em 0;}[type="checkbox"]{position:absolute;left:-9999px;}label{display:block;width:100%;height:1.1em;cursor:pointer;top:0;padding-left:1.1em;}label:before{content:'Table of contents \25BC';font-weight:bold;font-size:90%;padding-bottom:0;}[type="checkbox"] ~ div{display:none;}[type="checkbox"]:checked ~ div{display:block;margin-top:1.1em;}[type="checkbox"]:checked + label{top:100%;}[type="checkbox"]:checked + label:before{content:'Table of contents ‚ñ≤';}div#footnotes_div p{line-height:1;padding-bottom:0;padding-top:0;}div#footnotes_div ol{padding-top:0;}@font-face{font-family:"APLFont";src:local("APL385 Unicode"), url("http://misc.aplteam.com/apl385.ttf") format("truetype");}.no_display{display:none;}.red{color:red;}img{margin-top:0.55em;margin-bottom:0.27em;}div.leanpub{padding:0.83em 0.55em 1.11em 0;margin:0.55em 0 0 0.27em;overflow:auto;}div.leanpub_A{border:1px solid black;background-color:#f1f1f1;padding:0.55em;margin:1.11em 0 0.83em 0;}div.leanpub h3, div.leanpub_A h3{font-size:1.2em;padding:0;margin:0;}div.leanpub h4, div.leanpub_A h4{font-size:1.1em;padding:0.27em 0 0 0;margin:0;}div.leanpub h5, div.leanpub h5{font-size:1.0em;padding:0.27em 0 0 0;margin:0;}div.leanpub_A h5, div.leanpub_A h5{font-size:1.0em;padding:0.27em 0 0 0;margin:0;}div.leanpub img{padding:0;margin:0 1.11em 0.27em 0;}div.leanpub_A > p:first-child{padding-top:0;margin-top:0;}div.leanpub img{float:left;padding:0;margin:0.55em 1.11em 0 0;clear:both;}div.leanpub tbody *{background-color:transparent;}div.leanpub p{padding:0.17em 0 0 0;margin:0;}span.leanpub_code{color:Red;}div.leanpub p{display:block;padding:0.44em 0 0 0;}div.leanpub > div{margin-left:2.27em;}
</style>
<style media="print">
@page{margin:25mm 20mm 25mm 20mm;}body{font-family:"Bookman Old Style", "Callisto MT", Bookman,"Goudy Old Style", Garamond, serif;font-size:9pt;line-height:1.2;}h1{font-size:170%;}h2{font-size:110%;}h3{font-size:110%;}h4{font-size:105%;}h5{font-size:100%;}h6{font-size:95%;}h1{margin:0 0 20pt 0;}h2{margin:15pt 0 3pt 0;}h3{margin:10pt 0 0pt 0;}h4{margin:10pt 0 0pt 0;}h5{margin:9pt 0 0pt 0;}h6{margin:9pt 0 0pt 0;}h1, h2, h3, h4, h5, h6{color:black;font-family:"Century Gothic", Verdana, "Sans";page-break-after:avoid;}h1 > code, h2 > code, h3 > code, h4 > code, h5 > code, h6 > code{font-size:100%;}h2{border-bottom:1pt solid Silver;padding-bottom:2pt;}.h_tag{page-break-after:avoid;break-after:avoid;}abbr[title]{border-bottom:0;text-decoration:none;}a{color:black;margin:0;padding:0;vertical-align:baseline;text-decoration:none;font-style:italic;}a.autoheader_anchor{text-decoration:none;font-style:normal;page-break-after:avoid;break-after:avoid;}ul{list-style-type:square;}ul, ol{padding:0;margin:0;}li > ul, ol{padding-bottom:0;}li{line-height:1.3;margin-left:13pt;margin-bottom:5pt;}ul > li{margin-left:10pt;}li ul{margin-left:5pt;}li ul{margin-left:3pt;}li p{padding:1pt 0 0 0;margin:5pt 0 3pt 0;line-height:1.3;}p, ul, ol{line-height:1.3;padding:4pt 0 0 0;margin:0;color:black;}pre{padding:3pt;margin:5pt 0;white-space:pre-wrap;background-color:#FAFAFA;border:1pt Silver solid;display:block;font-family:APLFont, monospace;page-break-inside:avoid;-webkit-print-color-adjust:exact;}pre code{background-color:#FAFAFA;color:Black;padding:0;margin:0 0 -6pt 0;line-height:1.1;border:0;}code{font-family:APLFont, monospace;line-height:1.2;font-size:9pt;padding:3pt 1pt 3pt 1pt;color:#950000;padding:3pt 4pt 3pt 4pt;}tbody th, tfoot tr{background-color:#e6e6e6;}tbody tr:nth-child(even){background-color:#fafafa;}th{background-color:#F0F0F0;}th, td{padding:1pt 5pt;}table{margin:10pt 0;font-family:APLFont;font-size:9pt;padding:0;border:1pt solid silver;-webkit-print-color-adjust:exact;}li > table{margin:10pt 0 10pt 0;}tr{margin:20pt;}th{font-weight:bold;}tfoot td{font-weight:bold;}blockquote{border-left:5pt solid silver;padding-left:5pt;margin:8pt 3pt 8pt 8pt;}nav{background-color:#f8f8f8;border:1pt solid Gray;width:auto;float:right;padding:5pt 5pt 5pt 0;margin:5pt 0 5pt 5pt;page-break-inside:avoid;}nav *{font-size:75%;}nav ul{list-style-type:none;margin:0 0 2pt 0;padding:0;}nav ul li{margin-bottom:0;}nav li p{margin:0;padding:0;line-height:1;margin:0;padding:0;}nav li{font-size:9pt;line-height:1;padding:0;margin-top:0;margin-bottom:0;margin-left:8pt;}dl{margin-top:0;margin-bottom:10pt;}dt{margin-top:10pt;margin-bottom:0;font-weight:800;page-break-inside:avoid;}dd{margin-top:2pt;}label#hide_toc_label{font-size:65%;}.toc-container{position:relative;height:auto;margin-top:5pt;}.toc-container h1{margin:0 0 7pt 7pt;}[type="checkbox"]{display:none;}label{display:block;width:100%;height:1.1em;top:0;padding-left:10pt;}label:before{content:'Table of contents';font-weight:bold;font-size:140%;padding-bottom:10pt;}a.external_link::before{content:" üåé";}a.bookmark_link::before{content:" ‚ûØ";}a.mailto_link::before{content:" ‚úâ"}nav a.bookmark_link{font-style:normal;}nav p{margin-left:10pt;font-weight:bold;font-size:9pt;}nav a{font-style:normal;}nav a.bookmark_link::before{content:"";}div#footnotes_div a::before{content:"";}div#footnotes_div a{font-style:normal;}div#footnotes_div{page-break-inside:avoid;}@font-face{font-family:"APLFont";src:local("APL385 Unicode"), url("http://misc.aplteam.com/apl385.ttf") format("truetype");}.no_print{display:none;}.red{color:red;}.avoid_page_break{page-break-inside:avoid;}.page_break_before{page-break-before:auto;}div.leanpub{margin:10pt 0 10pt 8pt;page-break-inside:avoid;}div.leanpub_A{border:1pt solid black;background-color:#f9f9f9;padding:5pt;margin:10pt 0 10pt 0;page-break-inside:avoid;}div.leanpub h3, div.leanpub_A h3{font-size:1.2em;padding:3pt 0 0 0;margin:0;}div.leanpub h4, div.leanpub_A h4{font-size:1.1em;padding:3pt 0 0 0;margin:0;}div.leanpub h5, div.leanpub h5{font-size:1.0em;padding:3pt 0 0 0;margin:0;}div.leanpub_A h5, div.leanpub_A h5{font-size:1.0em;padding:3pt 0 0 0;margin:0;}div.leanpub img{padding:0;margin:0 10pt 2pt 0;}div.leanpub_A > p:first-child{padding-top:0;margin-top:0;}div.leanpub > div > h1:first-child{padding-top:5pt;}div.leanpub img{float:left;padding:0;margin:5pt 10pt 0 0;clear:both;}div.leanpub p{padding:3pt 0 0 0;margin:0;}span.leanpub_code{color:black;}div.leanpub p{display:block;padding:8pt 0 0 0;}div.leanpub > div{margin-left:35pt;}
</style>
<meta name="author" content="kai">
</head>
<body>
<nav id="main_nav_no_collapse">
<div class="toc-container">
<h3>Table of contents</h3>
<ul>
<li><a href="#What-is-a-Windows-Service">What is a Windows Service</a></li>
<li><a href="#Windows-Services-and-the-Windows-Event-Log">Windows Services and the Windows Event Log</a></li>
<li><a href="#Restrictions">Restrictions</a></li>
<li><a href="#The-ServiceState-namespace">The ServiceState namespace</a></li>
<li><a href="#Installing-a-Service">Installing a Service.</a>
<ul>
<li><a href="#DYALOG_NOPOPUPS">DYALOG_NOPOPUPS</a></li>
</ul></li>
<li><a href="#Uninstalling-a-service">Uninstalling a service</a></li>
<li><a href="#Obstacles">Obstacles</a>
<ul>
<li><a href="#The-Service-seems-to-be-doing-nothing-at-all">The Service seems to be doing nothing at all</a></li>
<li><a href="#The-Service-starts-but-ignores-Pause-and-Stop-requests">The Service starts but ignores Pause and Stop requests</a></li>
<li><a href="#The-application-does-not-do-what-it-is-supposed-to-do">The application does not do what it is supposed to do</a></li>
</ul></li>
<li><a href="#Potions-and-wands">Potions and wands</a>
<ul>
<li><a href="#Ride">Ride</a></li>
</ul></li>
<li><a href="#Logging">Logging</a>
<ul>
<li><a href="#Local-logging">Local logging</a>
<ul>
<li><a href="#Windows-event-log">Windows event log</a></li>
</ul></li>
</ul></li>
<li><a href="#How-to-implement-it">How to implement it</a>
<ul>
<li><a href="#Setting-the-latent-expression">Setting the latent expression</a></li>
<li><a href="#Initialising-the-Service">Initialising the Service</a></li>
<li><a href="#The-business-logic">The ‚Äúbusiness logic‚Äù</a></li>
</ul></li>
<li><a href="#Running-the-test-cases">Running the test cases</a>
<ul>
<li><a href="#Installing-and-un-installing-the-Service">Installing and un-installing the Service</a></li>
<li><a href="#Make-for-the-Service">‚ÄúMake‚Äù for the Service</a></li>
<li><a href="#Testing-the-Service">Testing the Service</a></li>
<li><a href="#Running-the-tests">Running the tests</a>
</li></ul></li>
</ul>
</div>
</nav>
<table style="font-size:xx-large;color:red;">
<tbody>
<tr>
<td><strong> This chapter needs attention due to the move to version 17.0!! </strong></td>
</tr>
</tbody>
</table>
<div class="h_tag">
<a href="#Windows-Services" id="Windows-Services" class="autoheader_anchor">
<h1>Windows Services</h1>
</a>
</div>
<div class="h_tag">
<a href="#What-is-a-Windows-Service" id="What-is-a-Windows-Service" class="autoheader_anchor">
<h2>What is a Windows Service</h2>
</a>
</div>
<p>While the Windows Task Manager just starts any ordinary application, an application that is supposed to run as a Windows Service must be specifically designed to meet certain requirements.</p>
<p>In particular, services communicate by exchanging messages with the Windows Service Control Manager (SCM).</p>
<p>Commands can be issued by the <code>SC.exe</code> (Service Controller) application via the command line or interactively via the Services application. Both allow the user to start, pause, continue (resume) and stop a Windows Service.</p>
<div class="h_tag">
<a href="#Windows-Services-and-the-Windows-Event-Log" id="Windows-Services-and-the-Windows-Event-Log" class="autoheader_anchor">
<h2>Windows Services and the Windows Event Log</h2>
</a>
</div>
<p>Our application is already prepared to write log files and save information in the event of a crash, but that's not sufficient: while applications started by the Windows Task Scheduler <em>might</em> write to the Windows Event Log, applications running as a Windows Service are <em>expected</em> to do that, and for good reasons: when running on a server one cannot expect anybody to be keeping an eye on log or crash files.</p>
<p>In large organisations running server farms it is common to have software in place that scans the Windows Event Logs of all the servers, and raises an alarm (TCP messages, text messages, emails, whatever) if it finds problems.</p>
<p>We won't add the ability to write to the Windows Event Log in this chapter, but rather discuss how to do this in the next chapter.</p>
<div class="h_tag">
<a href="#Restrictions" id="Restrictions" class="autoheader_anchor">
<h2>Restrictions</h2>
</a>
</div>
<p>With Dyalog version 17.0 we cannot install a stand-alone <abbr title="Executable file with the extension 'exe'">EXE</abbr> as a Windows Service. All we can do is to install a given interpreter and then ask it to load a workspace, which implies running <code>‚éïLX</code>. (This restriction may be lifted in a future version of Dyalog.)</p>
<p>That means that unless you're happy to expose your code, you have a problem. There are solutions:</p>
<ul>
<li>Lock all the functions and operators in the workspace.</li>
<li>Bury your APL code in .NET assemblies and call them from the workspace that runs as a Windows Service.</li>
<li>Start the stand-alone <abbr title="Executable file with the extension 'exe'">EXE</abbr> from the workspace that runs as a Windows Service, and communicate with it via TCP/Conga.</li>
</ul>
<p>All three solutions add a level of complexity just to hide the code, but at least there are several escape routes available.</p>
<p>We resume, as usual, by saving a copy of <code>Z:\code\v12</code> as <code>Z:\code\v13</code>.</p>
<div class="h_tag">
<a href="#The-ServiceState-namespace" id="The-ServiceState-namespace" class="autoheader_anchor">
<h2>The ServiceState namespace</h2>
</a>
</div>
<p>To simplify matters we shall use the <code>ServiceState</code> namespace, also from the APLTree project. It requires you to do just two things:</p>
<ol start="1">
<li>Call <code>ServiceState.Init</code> as early as possible. This function will ensure the Service can communicate with the SCM.
<p>Do it as early as possible to enure any request from the SCM will be answered promptly. Windows is not exactly patient when it waits for a Service to respond to a Pause, Resume or Stop request: you may see an error message complaining that the Service refused to cooperate after just 5 seconds, though Windows <em>might</em> wait a bit longer.</p>
<p>However, note that the interpreter confirms the Start request for us; no further action is required.</p>
<p>Create a parameter space by calling <code>CreateParmSpace</code>, and set at least the name of the log function and possibly the namespace (or class instance) the log function lives in. This log function is used to log any incoming requests from the SCM. The parameter space is then passed to <code>Init</code> as the right argument.</p></li>
<li>In its main loop the Service is expected to call <code>ServiceState.CheckServiceMessages</code>.
<p>This is an operator, so it needs a function as operand: that is, a function that is doing the logging, allowing <code>CheckServiceMessages</code> to log its actions to the log file. (If you don't need a log file then simply passing <code>{‚çµ}</code> will do.</p>
<p>When <code>CheckServiceMessages</code> is called if no request of the SCM is pending it will quit straight away and return a 0. If a Pause is pending then it goes into a loop, and continues to loop (with a <code>‚éïDL</code> in between) until either Continue (a.k.a. Resume) or Stop is requested by the SCM.</p>
<p>If a Stop is requested, the operator will quit and return a 1.</p></li>
</ol>
<div class="h_tag">
<a href="#Installing-a-Service" id="Installing-a-Service" class="autoheader_anchor">
<h2>Installing a Service.</h2>
</a>
</div>
<p><strong>Note:</strong> for installing a Service you need admin rights, for uninstalling a Service you even need to execute the command in elevated mode.</p>
<p>Suppose you have loaded a <abbr title="Short for Workspaces">WS</abbr> <code>MyService</code> which you want to install as a Windows Service run by the same version of Dyalog you are currently in:</p>
<pre><code>aplexe‚Üê'"',(2 ‚éïNQ # 'GetEnvironment' 'dyalog'),'\dyalogrt.exe"'
wsid‚Üê'"whereEverTheWsLives\MyAppService.DWS"'
cmd‚Üêaplexe,' ',wsid,' APL_ServiceInstall=MyAppService DYALOG_NOPOPUPS=1'</code></pre>
<p><code>cmd</code> could now be executed with the <code>Execute</code> class introduced in the chapter ‚Äú<a href="./07 Handling errors.html" class="external_link">Handling Errors</a>‚Äù. That would do the trick.</p>
<div class="h_tag">
<a href="#DYALOG_NOPOPUPS" id="DYALOG_NOPOPUPS" class="autoheader_anchor">
<h3>DYALOG_NOPOPUPS</h3>
</a>
</div>
<p>Setting this to 1 prevents any dialogs popping up (aplcore, <abbr title="Short for Workspaces">WS</abbr> FULL etc.). You don't want them when Dyalog is running in the background because it would not show any GUI controls. But even if it would, there's no guarantee that anybody would be around in order to click the <em>OK</em> button.</p>
<p>This also prevents the <em>Service MyAppService successfully installed</em> message from popping up. You don't want to see that when executing tests that install, start, pause, resume, stop and uninstall a Service, or when you have an automated Build process in place.</p>
<div class="h_tag">
<a href="#Uninstalling-a-service" id="Uninstalling-a-service" class="autoheader_anchor">
<h2>Uninstalling a service</h2>
</a>
</div>
<p>To uninstall the Service, simply open a console window with <em>Run as administrator</em> and enter:</p>
<pre><code>sc delete MyAppService</code></pre>
<p>and you are done.</p>

<div class="leanpub_A">
<h3>Pitfalls when installing or uninstalling Windows Services</h3>
<p>When you have opened the <em>Services</em> GUI while installing or uninstalling a Windows Service you must press F5 on the GUI to refresh the display.</p>
<p>The problem is not just that the GUI does not update itself ‚Äì annoying as that may be. You might end up with a Service marked in the GUI as <code>disabled</code>, after which you might need to reboot the machine.</p>
<p>This can happen if you try to perform an action from the GUI when it is out of sync with the Service's current state.</p>
</div>

<div class="leanpub_A">
<h3>SC: Service Control</h3>
<p><code>SC</code> is a command line program that allows a user with admin rights to issue particular commands regarding Windows Services. The general format is:</p>
<pre><code>SC.exe {command} {serviceName}</code></pre>
<p>Commonly used commands are:</p>
<ul>
<li>create</li>
<li>start</li>
<li>pause</li>
<li>continue</li>
<li>stop</li>
<li>query</li>
<li>delete</li>
</ul>
</div>

<div class="h_tag">
<a href="#Obstacles" id="Obstacles" class="autoheader_anchor">
<h2>Obstacles</h2>
</a>
</div>
<p>From experience we know there are pitfalls. These are some of the problems you might encounter:</p>
<ol start="1">
<li>The Service appears to start (shows <em>running</em> in the Services GUI) but nothing happens at all.</li>
<li>The Service starts, the log file confirms it, but once you request the Service to pause or stop you get nothing but a Windows error message.</li>
<li>The Service runs, but the application does not do anything, or it does something unexpected.</li>
</ol>
<p>We discuss these problems one after the other.</p>
<div class="h_tag">
<a href="#The-Service-seems-to-be-doing-nothing-at-all" id="The-Service-seems-to-be-doing-nothing-at-all" class="autoheader_anchor">
<h3>The Service seems to be doing nothing at all</h3>
</a>
</div>
<p>If a Service does not seem to do anything when started:</p>
<ul>
<li>Check the name and path of the workspace the Service is expected to load: if that's wrong you won't see anything at all - the message ‚ÄúWorkspace not found‚Äù goes straight into the ether.</li>
<li>Make sure the workspace size is sufficent. Insufficient memory conceals any error message.</li>
<li>The Service might create an aplcore when it starts.</li>
<li>Start the Event Viewer and check it for useful information. Although our application does not write to the application log (yet), the SCM might do!</li>
</ul>

<div class="leanpub_A">
<h3>CONTINUE workspaces</h3>
<p>The Service might have created a CONTINUE workspace, for various reasons.</p>
<p>Note that, starting with version 17.0, Dyalog no longer drops a CONTINUE workspace by default. You must configure Dyalog to do so.</p>
<p>A CONTINUE cannot be saved if there is more than one thread running ‚Äì and Services are by definition multi-threaded. However, if it fails very early there <em>might</em> still be a CONTINUE.</p>
<p>Once a second thread is started, Dyalog is no longer able to save a CONTINUE workspace. Establishing error trapping before a second thread is started avoids this problem.</p>
</div>

<div class="leanpub_A">
<h3>aplcores</h3>
<p>Writing to the directory the service is installed in might be prohibited by Windows. That might well prevent a CONTINUE or aplcore from being saved.</p>
<p>While you cannot choose the folder in which a CONTINUE would be saved you can define a folder for aplcores:</p>
<pre><code>`APLCORENAME='/pathToFolder/my_aplcore*`.</code></pre>
<p>This saves any aplcore as ‚Äúmy_aplcore‚Äù followed by a running number. For more information regarding aplcores see ‚Äú<a href="./52 Appendix 3 ‚Äî aplcores and WS integrity.html" class="external_link">Appendix 3 ‚Äî aplcores and WS integrity</a>‚Äù.</p>
</div>

<div class="h_tag">
<a href="#The-Service-starts-but-ignores-Pause-and-Stop-requests" id="The-Service-starts-but-ignores-Pause-and-Stop-requests" class="autoheader_anchor">
<h3>The Service starts but ignores Pause and Stop requests</h3>
</a>
</div>
<p>The log file contains everything we expect: calling parameters etc. In such a case we <em>know</em> the Service started and is running.</p>
<ul>
<li>Check you have really called <code>ServiceState.Init</code>.</li>
<li>Check you have called <code>CheckServiceMessages</code> in the main loop of the application.</li>
</ul>
<p>If these two conditions are met then it's hard to imagine what could prevent the application from reacting to any requests of the SCM, except when you have an endless loop somewhere in your application.</p>
<div class="h_tag">
<a href="#The-application-does-not-do-what-it-is-supposed-to-do" id="The-application-does-not-do-what-it-is-supposed-to-do" class="autoheader_anchor">
<h3>The application does not do what it is supposed to do</h3>
</a>
</div>
<blockquote>
<p>The very thought of you And I forget to do Those ordinary things That everyone ought to do</p>
<p>‚Äî <em>Cole Porter</em></p>
</blockquote>
<p>First and foremost it is worth repeating that any application supposed to run as a Service should be developed as an ordinary application, including test cases. When it passes such test cases you have reasons to be confident the application will run as a Service too.</p>
<p>Having said this, there can be surprising differences between running as an ordinary application and as a Service. For example, when a Service runs not with a user's account, but with the system account (which is quite normal to do) any call to <code>#.FilesAndDirs.GetTempPath</code> results in</p>
<p><code>"C:\Windows\Temp"</code></p>
<p>When a service runs under the account of a user you will get this:</p>
<p><code>"C:\Windows\System32\config\systemprofile\AppData\Local\Apps"</code></p>
<p>while for a user's account it would be something like</p>
<p><code>'C:\Users\{username}\AppData\Local\Temp'</code>.</p>
<p>When the application behaves in an unexpected way you need to debug it, and for that Ride is invaluable.</p>
<div class="h_tag">
<a href="#Potions-and-wands" id="Potions-and-wands" class="autoheader_anchor">
<h2>Potions and wands</h2>
</a>
</div>
<div class="h_tag">
<a href="#Ride" id="Ride" class="autoheader_anchor">
<h3>Ride</h3>
</a>
</div>
<p>First of all we have to make sure that the application will give us a Ride if we need one. Since passing any arguments for a Ride via the command line requires the Service to be uninstalled and installed at least twice we recommend preparing the Service from within the application instead.</p>
<p>If you have trouble Riding into any kind of application, check there is not an old instance of the Service running and occupying the port you need for the Ride.</p>
<p>There are two very different scenarios in which you might want to use Ride:</p>
<ol start="1">
<li>The Service does not seem to start or does not respond to Pause or Stop requests.</li>
<li>The Service starts fine and responds properly to Pause or Stop requests, but the application is otherwise behaving unexpectedly.</li>
</ol>
<p>In the former case ensure as soon as possible after startup you allow the programmer to Ride into the Service. The first line of the function in <code>‚éïLX</code> should provide a Ride.</p>
<p>At such an early stage we don't have an <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> file instantiated, so we cannot switch Ride on and off via the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> file, we have to modify the code for that.</p>
<p>You might feel tempted to overcome this by doing it a bit later (e.g. after processing the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> file) but beware: if a Service is not cooperating then ‚Äúa bit later‚Äù might be too late; resist the temptation!</p>
<p>In the second case, add the call to <code>CheckForRide</code> once the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> file has been instantiated.</p>
<div class="h_tag">
<a href="#Logging" id="Logging" class="autoheader_anchor">
<h2>Logging</h2>
</a>
</div>
<div class="h_tag">
<a href="#Local-logging" id="Local-logging" class="autoheader_anchor">
<h3>Local logging</h3>
</a>
</div>
<p>We want to log as soon as possible any command-line parameters as well as any message exchange between the Service and the SCM.</p>
<p>Again we advise you not to wait until the folder holding the log files is defined by instantiating the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> file. Instead we suggest making the assumption that a certain folder (‚ÄúLogs‚Äù) will (or might) exist in the current directory which will become where the workspace was loaded from.</p>
<p>If that's not convenient, consider passing the directory that will contain the <code>Logs</code> folder as a command line parameter.</p>
<div class="h_tag">
<a href="#Windows-event-log" id="Windows-event-log" class="autoheader_anchor">
<h4>Windows event log</h4>
</a>
</div>
<p>In the next chapter (‚Äú<a href="./14 The Windows Event Log.html" class="external_link">The Windows Event Log</a>‚Äù) we will discuss why and how to use the Windows Event Log, in particular when it comes to Services.</p>
<div class="h_tag">
<a href="#How-to-implement-it" id="How-to-implement-it" class="autoheader_anchor">
<h2>How to implement it</h2>
</a>
</div>
<div class="h_tag">
<a href="#Setting-the-latent-expression" id="Setting-the-latent-expression" class="autoheader_anchor">
<h3>Setting the latent expression</h3>
</a>
</div>
<p>First of all we need to point out that <code>MyApp</code> as it stands is not a candidate for a Service, therefore we need to make something up.</p>
<p>Let's specify one or more folders to be watched by the <code>MyApp</code> Service. If any files are found then they are processed. Finally the app will store hashes for all the files it has processed. That allows it to recognize any added, changed or removed files efficiently.</p>
<p>For the Service we need to create a workspace that can be loaded by that Service. Therefore we need to set <code>‚éïLX</code>, and for that we create a new function:</p>
<pre><code> ‚àá {r}‚ÜêSetLXForService(earlyRide ridePort)
   ‚çù Set Latent Expression (needed in order to export workspace as EXE)
   ‚çù `earlyRide` is a flag. 1 allows a Ride.
   ‚çù `ridePort`  is the port number to be used for a Ride.
      #.‚éïIO‚Üê1 ‚ãÑ #.‚éïML‚Üê1 ‚ãÑ #.‚éïWX‚Üê3 ‚ãÑ #.‚éïPP‚Üê15 ‚ãÑ #.‚éïDIV‚Üê1
      r‚Üê‚ç¨
      ‚éïLX‚Üê'#.MyApp.RunAsService ',(‚çïearlyRide),' ',(‚çïridePort)
 ‚àá</code></pre>
<p>The function takes a flag <code>earlyRide</code> and an integer <code>ridePort</code> as arguments. How and when this function is called will be discussed in a moment.</p>
<p>Because we have now two functions that set <code>‚éïLX</code> we shall rename the original one (<code>SetLX</code>) to <code>SetLXForApplication</code> to tell them apart.</p>
<div class="h_tag">
<a href="#Initialising-the-Service" id="Initialising-the-Service" class="autoheader_anchor">
<h3>Initialising the Service</h3>
</a>
</div>
<p>Next we need the main function for the service:</p>
<pre><code> ‚àá {r}‚ÜêRunAsService(earlyRide ridePort);‚éïTRAP;MyLogger;Config;‚àÜFileHashes
    ‚çù Main function when app is running as a Windows Service.
    ‚çù `earlyRide`: flag that allows a very early Ride.
    ‚çù `ridePort`: Port number used by Ride.
      r‚Üê‚ç¨
      CheckForRide(earlyRide√óridePort)1
      #.FilesAndDirs.PolishCurrentDir
      ‚éïTRAP‚Üê#.HandleError.SetTrap ‚ç¨
      (Config MyLogger)‚ÜêInitial #.ServiceState.IsRunningAsService
      ‚éïTRAP‚Üê(Config.Debug=0)SetTrap Config
      Config.ControlFileTieNo‚ÜêCheckForOtherInstances ‚ç¨
      ‚àÜFileHashes‚Üê0 2‚ç¥''
      :If #.ServiceState.IsRunningAsService
          {MainLoop ‚çµ}&amp;‚ç¨
          ‚éïDQ'.'
      :Else
          MainLoop ‚ç¨
      :EndIf
      Cleanup ‚ç¨
      Off EXIT.OK
    ‚àá</code></pre>
<p>Notes:</p>
<ul>
<li>This function allows a Ride very early indeed.</li>
<li>It calls the function <code>Initial</code> and passes the result of the function <code>#.ServiceState.IsRunningAsService</code> as right argument. We will discuss <code>Initial</code> next.</li>
<li>We create a global variable <code>‚àÜFileHashes</code>, which we use to collect the hashes of all files that we have processed. This gives us a fast and easy way to check whether any of the files we've already processed have changed since.</li>
<li>We call <code>MainLoop</code> (a function that has not been established yet) in different ways depending on whether the function is running as a Windows Service or not, for the simple reason that it is much easier to debug an application that runs in a single thread.</li>
</ul>
<div class="h_tag">
<a href="#The-business-logic" id="The-business-logic" class="autoheader_anchor">
<h3>The ‚Äúbusiness logic‚Äù</h3>
</a>
</div>
<p>Time to change the <code>MyApp.Initial</code> function:</p>
<pre><code>leanpub-start-insert
 ‚àá (Config MyLogger)‚ÜêInitial isService;parms
</span>    ‚çù Prepares the application.
<span class="leanpub_code">      Config‚ÜêCreateConfig isService
</span>      Config.ControlFileTieNo‚ÜêCheckForOtherInstances ‚ç¨
      CheckForRide Config.(Ride WaitForRide)
      MyLogger‚ÜêOpenLogFile Config.LogFolder
      MyLogger.Log'Started MyApp in ',F.PWD
      MyLogger.Log 2 ‚éïNQ'#' 'GetCommandLine'
      MyLogger.Log‚Üì‚éïFMT Config.‚àÜList
<span class="leanpub_code">      :If isService
          parms‚Üê#.ServiceState.CreateParmSpace
          parms.logFunction‚Üê'Log'
          parms.logFunctionParent‚ÜêMyLogger
          #.ServiceState.Init parms
      :EndIf
</span> ‚àá</code></pre>
<p>Note that we pass <code>isService</code> as right argument to <code>CreateConfig</code>, so we must amend <code>CreateConfig</code> accordingly:</p>
<pre><code>leanpub-start-insert
 ‚àá Config‚ÜêCreateConfig isService;myIni;iniFilename
</span>   Config‚Üê‚éïNS''
   ...
<span class="leanpub_code">   Config.IsService‚ÜêisService
</span>   ...
       Config.Accents‚Üê‚äÉConfig.Accents myIni.Get'Config:Accents'
<span class="leanpub_code">        :If isService
            Config.WatchFolders‚Üê‚äÉmyIni.Get'Folders:Watch'
        :Else
            Config.LogFolder‚Üê'expand'F.NormalizePath‚äÉConfig.LogFolder myIni.Get'Folders:Logs'
        :EndIf
</span>        Config.DumpFolder‚Üê'expand'F.NormalizePath‚äÉConfig.DumpFolder myIni.Get'Folders:Errors'
   ...
 ‚àá</code></pre>
<p>Note that <code>WatchFolder</code> is introduced only when the application is running as a Service.</p>
<p>Time to introduce the function <code>MainLoop</code>:</p>
<pre><code>‚àá {r}‚ÜêMainLoop port;S
  r‚Üê‚ç¨
  MyLogger.Log'"MyApp" server started'
  S‚Üê#.ServiceState
  :Repeat
      LoopOverFolder ‚ç¨
      :If (MyLogger.Log S.CheckServiceMessages)S.IsRunningAsService
          MyLogger.Log'"MyApp" is about to shut down...'
          :Leave
      :EndIf
      ‚éïDL 2
  :Until 0
 ‚çùDone
‚àá</code></pre>
<p>Notes:</p>
<ul>
<li>The call to <code>ServiceState.CheckServiceMessages</code> ensures the function reacts to any status-change requests from the SCM.</li>
<li><code>LoopOverFolder</code> is doing the real work.</li>
</ul>
<p>The function <code>LoopOverFolder</code>:</p>
<pre><code>‚àá {r}‚ÜêLoopOverFolder dummy;folder;files;hashes;noOf;rc
  r‚Üê‚ç¨
  :For folder :In Config.WatchFolders
      files‚Üê#.FilesAndDirs.ListFiles folder,'\*.txt'
      hashes‚ÜêGetHash¬®files
      (files hashes)‚Üê(~hashes‚àä‚àÜFileHashes[;2])‚àò/¬®files hashes
      :If 0&lt;noOf‚ÜêLoopOverFiles files hashes
          :If EXIT.OK=rc‚ÜêTxtToCsv folder
              MyLogger.Log'Totals.csv updated'
          :Else
              LogError rc('Could not update Totals.csv, RC=',EXIT.GetName rc)
          :EndIf
      :EndIf
  :EndFor
‚àá</code></pre>
<p>This function calls <code>GetHash</code> so we better introduce it:</p>
<pre><code> GetHash‚Üê{
 ‚çù Get hash for file ‚çµ
     ‚ä£2 ‚éïNQ'#' 'GetBuildID'‚çµ
 }</code></pre>
<p>The function <code>LoopOverFiles</code>:</p>
<pre><code> ‚àá noOf‚ÜêLoopOverFiles(files hashes);file;hash;rc
   noOf‚Üê0
   :For file hash :InEach files hashes
       :If EXIT.OK=rc‚ÜêTxtToCsv file
           ‚àÜFileHashes‚ç™‚Üêfile hash
           noOf+‚Üê1
       :EndIf
   :EndFor
 ‚àá</code></pre>
<p>This function finally calls <code>TxtToCsv</code>.</p>
<p>Because of the change we've made to the right argument of <code>Initial</code> we need to change <code>StartFromCmdLine</code>. Here the function <code>Initial</code> needs to be told it is <em>not</em> running as a Service:</p>
<pre><code>‚àá {r}‚ÜêStartFromCmdLine arg;MyLogger;Config;rc;‚éïTRAP
...
   (Config MyLogger)‚ÜêInitial #.ServiceState.IsRunningAsService
...</code></pre>
<p>Two more changes:</p>
<pre><code> ‚àá {r}‚ÜêCleanup dummy
   r‚Üê‚ç¨
   ‚éïFUNTIE Config.ControlFileTieNo
   Config.ControlFileTieNo‚Üê‚ç¨
<span class="leanpub_code">   '#'‚éïWS'Event' 'ServiceNotification' 0
</span> ‚àá</code></pre>
<p>This disconnects the handler from the ServiceNotification event.</p>
<p>Finally we redefine which functions are public:</p>
<pre><code> ‚àá r‚ÜêPublicFns
<span class="leanpub_code">   r‚Üê'StartFromCmdLine' 'TxtToCsv' 'SetLXForApplication' 'SetLXForService' 'RunAsService'
</span> ‚àá</code></pre>
<div class="h_tag">
<a href="#Running-the-test-cases" id="Running-the-test-cases" class="autoheader_anchor">
<h2>Running the test cases</h2>
</a>
</div>
<p>Now it's time to see if we broke anything. Double-click <code>MyApp.dyapp</code> and type <code>y</code> to answer the question whether you would like to run all test cases. If anything fails, execute <code>#.Tests.RunDebug 0</code> and fix the problem.</p>
<p>In order to run the service-specific test cases we need to make some preparations.</p>
<div class="h_tag">
<a href="#Installing-and-un-installing-the-Service" id="Installing-and-un-installing-the-Service" class="autoheader_anchor">
<h3>Installing and un-installing the Service</h3>
</a>
</div>
<p>In order to install or uninstall the Service we need two BATs: <code>Install_Service.bat</code> and <code>Uninstall_Service.bat</code>. We will write these BATs from Dyalog. For that we create a class <code>ServiceHelpers</code>:</p>
<pre><code>:Class ServiceHelpers

    ‚àá {r}‚ÜêCreateBatFiles dummy;path;cmd;aplexe;wsid
      :Access Public Shared
    ‚çù Write two BAT files to the current directory:
    ‚çù Install_Service.bat and Uninstall_Service.bat
      r‚Üê‚ç¨
      path‚Üê#.FilesAndDirs.PWD

      aplexe‚Üê'"',(2 ‚éïNQ'#' 'GetEnvironment' 'dyalog'),'\dyalogrt.exe"'
      wsid‚Üê'"%~dp0\MyAppService.DWS"'
      cmd‚Üêaplexe,' ',wsid,' APL_ServiceInstall=MyAppService'
     ‚çùcmd,‚Üê' APLCORENAME={path}\Aplcores_*'
     ‚çùcmd,‚Üê' DYALOG_EVENTLOGNAME={foo}'
      cmd,‚Üê' DYALOG_NOPOPUPS=1'
      cmd,‚Üê' MAXWS=64MB'
      #.APLTreeUtils.WriteUtf8File(path,'\Install_Service.bat')cmd

      cmd‚Üê‚äÇ'sc delete MyAppService'
      cmd,‚Üê‚äÇ'@echo off'
      cmd,‚Üê‚äÇ'    echo Error %errorlevel%'
      cmd,‚Üê‚äÇ'    if NOT ["%errorlevel%"]==["0"] ('
      cmd,‚Üê‚äÇ'    pause'
      cmd,‚Üê‚äÇ'exit /b %errorlevel%'
      cmd,‚Üê‚äÇ')'
      #.APLTreeUtils.WriteUtf8File(path,'\Uninstall_Service.bat')cmd
     ‚çùDone
    ‚àá

:EndClass</code></pre>
<p>Notes:</p>
<ul>
<li>The install <abbr title="Executable file that contains batch commands">BAT</abbr> will use the version of Dyalog used to create the <abbr title="Executable file that contains batch commands">BAT</abbr> file, and it will call the runtime <abbr title="Executable file with the extension 'exe'">EXE</abbr>.</li>
<li><code>%~dp0</code> stands for: the directory from which this <abbr title="Executable file that contains batch commands">BAT</abbr> was loaded. In other words, as long as the workspace <code>MyAppService.DWS</code> (which we have not created yet) is a sibling of the <abbr title="Executable file that contains batch commands">BAT</abbr>, it will work.</li>
<li>The setting of <code>APLCORENAME</code> specifies folder and name of any aplcores.
<p>For example, <code>D:\MyAplcores\aplcore_64_17_0_Unicode_*</code> would specify in which folder the aplcores shall be saved and that the filenames should start with <code>aplcore_64_17_0_Unicode_</code> followed by a running number (the asterisk).</p></li>
<li>By setting <code>DYALOG_EVENTLOGNAME</code> you tell the interpreter to write messages to the Windows Event Log, and what name to use for this.</li>
<li>The uninstall <abbr title="Executable file that contains batch commands">BAT</abbr> will check the <code>errorlevel</code> variable.
<p>If it detects an error it will pause so that one can actually see the error message even when we have just double-clicked the <abbr title="Executable file that contains batch commands">BAT</abbr>. This is discussed in the chapter <a href="./07 Handling errors.html" class="external_link"><em>Handling errors</em></a>.</p></li>
</ul>
<div class="h_tag">
<a href="#Make-for-the-Service" id="Make-for-the-Service" class="autoheader_anchor">
<h3>‚ÄúMake‚Äù for the Service</h3>
</a>
</div>
<p>Now it's time to create a <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr> for the service. For that copy <code>Make.dyapp</code> as <code>MakeService.dyapp</code> and then edit it:</p>
<pre><code>Target #
Load ..\AplTree\APLTreeUtils
Load ..\AplTree\FilesAndDirs
Load ..\AplTree\HandleError
Load ..\AplTree\IniFiles
Load ..\AplTree\OS
Load ..\AplTree\Logger
Load ..\AplTree\EventCodes
Load Constants
Load Utilities
Load MyApp

<span class="leanpub_code">Load ..\AplTree\ServiceState
</span>Load ..\AplTree\Tester
Load ..\AplTree\Execute
<span class="leanpub_code">Load ..\AplTree\WinSys
Load TestsForServices
</span>Load ServiceHelpers

<span class="leanpub_code">Run #.ServiceHelpers.CreateBatFiles ‚ç¨
Run '#.‚éïEX''ServiceHelpers'''
Run #.MyApp.SetLXForService 0 4599   ‚çù [1|0]: Ride/no Ride, [n] Ride port number

Load MakeService
Run #.MakeService.Run 0
</span></code></pre>
<p>Notes:</p>
<ul>
<li>We need some more APLTree modules: <code>Tester</code>, <code>Execute</code> and <code>WinSys</code>.</li>
<li>Ensure the two BATs (for installing and uninstalling the service) are written to the disk.</li>
<li>We delete the class <code>ServiceHelpers</code>: it is not needed for running the Service once we've created the BATs.</li>
<li>We set <code>‚éïLX</code> by calling <code>SetLXForService</code>.</li>
<li>We load the class <code>MakeService</code> and run <code>MakeService.Run</code>.</li>
</ul>
<p>That obviously requires the class <code>MakeService</code>:</p>
<pre><code>:Class MakeService
‚çù Creates a workspace "MyAppService" which can then run as a service.
‚çù 1. Re-create folder DESTINATION in the current directory
‚çù 2. Copy the INI file template over to DESTINATION\ as MyApp.ini
‚çù 3. Save the workspace within DESTINATION
    ‚éïIO‚Üê1 ‚ãÑ ‚éïML‚Üê1
    DESTINATION‚Üê'MyAppService'

    ‚àá {r}‚ÜêRun offFlag;en;F;U
      :Access Public Shared
      r‚Üê‚ç¨
      (F U)‚Üê##.(FilesAndDirs Utilities)
      (rc en more)‚ÜêF.RmDir DESTINATION
      U.Assert 0=rc
      U.Assert 'Create!'F.CheckPath DESTINATION
      'MyApp.ini.template' CopyTo DESTINATION,'\MyApp.ini'
      'Install_Service.bat' CopyTo DESTINATION,'\'
      'Uninstall_Service.bat' CopyTo DESTINATION,'\'
      ‚éïWSID‚ÜêDESTINATION,'\',DESTINATION
      #.‚éïEX‚çï‚éïTHIS
      0 ‚éïSAVE ‚éïWSID
      {‚éïOFF}‚ç£(‚äÉoffFlag)‚ä£‚ç¨
    ‚àá

    ‚àá {r}‚Üêfrom CopyTo to;rc;more;msg
      r‚Üê‚ç¨
      (rc more)‚Üêfrom F.CopyTo to
      msg‚Üê'Copy failed RC=' ,(‚çïrc),'; ',more
      msg ‚éïsignal 11/‚ç®0‚â†rc
    ‚àá
:EndClass</code></pre>
<p>Notes:</p>
<ul>
<li>Assigns the name of the destination folder to the global <code>DESTINATION</code>.</li>
<li>(Re-)creates a folder with the name in <code>DESTINATION</code>.</li>
<li>Copies over the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> as well as the two BATs.</li>
<li>Finally it sets <code>‚éïWSID</code> and saves the workspace, without the status indicator, and without <code>MakeService</code> ‚Äì by deleting itself.</li>
</ul>

<div class="leanpub_A">
<h3>Self-deleting code</h3>
<p>How it is possible for the function <code>MakeService.Run</code> to delete itself and keep running anyway?</p>
<p>APL code (functions, operators and scripts) is copied onto the stack for execution. You can investigate the stack at any given moment with <code>)SI</code> and <code>)SINL</code>; for details type the command in question into the session and then press F1.</p>
<p>Even if the code of a class executes <code>‚éïEX ‚çï‚éïTHIS</code> or a function or operator <code>‚éïEX ‚äÉ‚éïSI</code> the code keeps running because the copy on the stack will exist until the function or operator quits. Scripts might even live longer: only when the last reference pointing to a script is deleted does the script cease to exist.</p>
</div>

<div class="h_tag">
<a href="#Testing-the-Service" id="Testing-the-Service" class="autoheader_anchor">
<h3>Testing the Service</h3>
</a>
</div>
<p>We have test cases that tell us the ‚Äúbusiness logig‚Äù of <code>MyApp</code> works just fine. But we also need to make sure that it runs fine as a Windows Service as well.</p>
<p>Since the two test scenarios are only loosely related we want to keep those tests separate. It is easy to see why: testing the Service means assembling all the needed stuff, installing the Service, carrying out the tests and finally un-installing the tests and cleaning up.</p>
<p>We don't want to execute all this unless we really have to.</p>
<p>We start by creating a new script <code>TestsForServices</code> which we save alongside the other scrips in <code>v13/</code>:</p>
<pre><code>:Namespace TestsForServices
‚çù Installs a service "MyAppService" in a folder within the Windows Temp directory with
‚çù a randomly chosen name. The tests then start, pause, continue and stop the service.\\
‚çù They also check whether the application produces the expected results.

    ‚éïIO‚Üê1 ‚ãÑ ‚éïML‚Üê1

:EndNamespace</code></pre>
<p>We now discuss the functions we are going to add one after the other. Note that the <code>Initial</code> function is particularly important in this scenario: we need to copy over all the stuff we need, code as well as input files, make adjustments, and install the Service.</p>
<p>This could all be done in a single function but it would be lengthy and difficult to read. To avoid this we split the function into obvious units. By naming those functions carefully we should get away without adding any comments because the code explains itself. Here we go:</p>
<pre><code>‚àá r‚ÜêInitial;rc;ini;row;bat;more
   :If #.WinSys.IsRunningAsAdmin
       ‚àÜPath‚Üê##.FilesAndDirs.GetTempFilename''
       #.FilesAndDirs.DeleteFile ‚àÜPath
       ‚àÜPath‚Üê¬Ø4‚Üì‚àÜPath      ‚çù Because we use it as a folder name no extension needed
       ‚àÜServiceName‚Üê'MyAppService'
       ‚àÜCreateFolderStructure ‚ç¨
       ‚àÜCopyFiles ‚ç¨
       ‚àÜCreateBATs ‚ç¨
       ‚àÜCreateIniFile ‚ç¨
       ‚àÜInstallService ‚ç¨
       ‚éï‚Üê'*** Service ',‚àÜServiceName,' successfully installed'
       r‚Üê1
   :Else
       ‚éï‚Üê'Sorry, but you need admin rights to run this test suite!'
       r‚Üê0
   :EndIf</code></pre>
<p>Note that all the sub-function and global variables start their names with <code>‚àÜ</code>. An example is the function <code>‚àÜExecute_SC_Cmd</code>:</p>
<pre><code>‚àá {(rc msg)}‚Üê‚àÜExecute_SC_Cmd command;cmd;buff
 ‚çù Executes an SC (Service Control) command
   rc‚Üê1 ‚ãÑ msg‚Üê'Could not execute the command'
   cmd‚Üê'SC ',command,' ',‚àÜServiceName
   buff‚Üê#.Execute.Process cmd
   ‚ÜíFailsIf 0‚â†1‚äÉbuff
   msg‚Üê‚äÉ,/2‚äÉbuff
   rc‚Üê3‚äÉbuff
‚àá</code></pre>
<p>It executes <code>SC</code> commands like <code>start</code>, <code>pause</code>, <code>continue</code>, <code>stop</code> and <code>query</code> by preparing a string and then passing it to <code>Execute.Process</code>.</p>
<p>It analyzes the result and returns the text part of it as well as a return code. While the first four commands aim to change the current status of a Service, <code>query</code> is designed to establish what the current status of a Service actually is.</p>
<p>After having executed the test suite we want to clean up, so we create a function <code>Cleanup</code>.</p>
<p>Remember: if the test framework finds a function <code>Initial</code>, it executes it <em>before</em> executing the actual test cases, while any function <code>Cleanup</code> will be executed <em>after</em> the test cases have been executed.</p>
<pre><code>‚àá {r}‚ÜêCleanup
   r‚Üê‚ç¨
   :If 0&lt;‚éïNC'‚àÜServiceName'
       ‚àÜExecute_SC_Cmd'stop'
       ‚àÜExecute_SC_Cmd'delete'
       ##.FilesAndDirs.RmDir ‚àÜPath
       ‚éïEX¬®'‚àÜPath' '‚àÜServiceName'
   :EndIf
‚àá</code></pre>
<p>We also need <code>‚àÜPause</code>:</p>
<pre><code>‚àá {r}‚Üê‚àÜPause seconds
   r‚Üê‚ç¨
   ‚éï‚Üê'   Pausing for ',(‚çïseconds),' seconds...'
   ‚éïDL seconds
‚àá</code></pre>
<p>We could discuss all the sub functions called by these two functions but it would tell us little. Therefore we suggest you copy the code from the web site. We discuss just the two test functions:</p>
<pre><code>‚àá R‚ÜêTest_01(stopFlag batchFlag);‚éïTRAP;rc;more
  ‚çù Start, pause, continue and stop the service.
  ‚éïTRAP‚Üê(999 'C' '. ‚çù Deliberate error')(0 'N')
  R‚Üê‚àÜFailed

  (rc more)‚Üê‚àÜExecute_SC_Cmd'start'
  ‚ÜíFailsIf 0‚â†rc
  ‚àÜPause 2
  (rc more)‚Üê‚àÜExecute_SC_Cmd'query'
  ‚ÜíFailsIf 0‚â†rc
  ‚ÜíFailsIf 0=‚à®/'STATE : 4 RUNNING'‚ç∑#.APLTreeUtils.dmb more

  (rc more)‚Üê‚àÜExecute_SC_Cmd'pause'
  ‚ÜíFailsIf 0‚â†rc
  ‚àÜPause 2
  ‚ÜíFailsIf 1‚â†‚ç¥#.FilesAndDirs.ListFiles ‚àÜPath,'\service\Logs\'
  (rc more)‚Üê‚àÜExecute_SC_Cmd'query'
  ‚ÜíFailsIf 0=‚à®/'STATE : 7 PAUSED'‚ç∑#.APLTreeUtils.dmb more

  (rc more)‚Üê‚àÜExecute_SC_Cmd'continue'
  ‚ÜíFailsIf 0‚â†rc
  ‚àÜPause 2
  (rc more)‚Üê‚àÜExecute_SC_Cmd'query'
  ‚ÜíFailsIf 0=‚à®/'STATE : 4 RUNNING'‚ç∑#.APLTreeUtils.dmb more

  (rc more)‚Üê‚àÜExecute_SC_Cmd'stop'
  ‚ÜíFailsIf 0‚â†rc
  ‚àÜPause 2
  (rc more)‚Üê‚àÜExecute_SC_Cmd'query'‚óã
  ‚ÜíFailsIf 0=‚à®/'STATE : 1 STOPPED'‚ç∑#.APLTreeUtils.dmb more

  R‚Üê‚àÜOK
‚àá</code></pre>
<p>In order to understand the <code>‚ÜíFailsIf</code> statements it is essential to have a look at a typical result returned by the <code>‚àÜExecute_SC_Cmd</code> function, in this case a query:</p>
<pre><code>      ‚ç¥more
328
      ‚â°more
1
      #.APLTreeUtils.dmb more
SERVICE_NAME: MyAppService TYPE : 10 WIN32_OWN_PROCESS STATE : 4 RUNNING (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN) WIN32_EXIT_CODE : 0 (0x0) SERVICE_EXIT_CODE
       : 0 (0x0) CHECKPOINT</code></pre>
<p>We have removed white space here to increase readability. (The result is richly endowed with them.)</p>
<p>This test starts, pauses, continues and finally stops the Service after having processed some files:</p>
<pre><code>‚àá R‚ÜêTest_02(stopFlag batchFlag);‚éïTRAP;rc;more;noOfCSVs;success;oldTotal;newTotal;A;F
  ‚çù Start service, check results, give it some more work to do, check and stop it.
   ‚éïTRAP‚Üê(999 'C' '. ‚çù Deliberate error')(0 'N')
   R‚Üê‚àÜFailed
   (A F)‚Üê#.(APLTreeUtils FilesAndDirs)

   (rc more)‚Üê‚àÜExecute_SC_Cmd'start'
   ‚ÜíFailsIf 0‚â†rc
   ‚àÜPause 1
   (rc more)‚Üê‚àÜExecute_SC_Cmd'query'
   ‚ÜíFailsIf 0=‚à®/'STATE : 4 RUNNING'‚ç∑A.dmb more

   ‚çù At this point the service will have processed all the text files, so there
   ‚çù must now be some CSV files, including the Total.csv file.
   ‚çù We then copy 6 more text files, so we should see 6 more CSVs &amp; a changed Total.
   oldTotal‚Üê‚Üë{','A.Split ‚çµ}¬®A.ReadUtf8File ‚àÜPath,'\input\en\total.csv'
   noOfCSVs‚Üê‚ç¥F.ListFiles ‚àÜPath,'\input\en\*.csv'
   (success more list)‚Üê(‚àÜPath,'\texts')F.CopyTree ‚àÜPath,'\input\'  ‚çù All of them
   {1‚â†‚çµ:.}success
   ‚àÜPause 2
   newTotal‚Üê‚Üë{','A.Split ‚çµ}¬®A.ReadUtf8File ‚àÜPath,'\input\en\total.csv'
   ‚ÜíPassesIf(noOfCSVs+6)=‚ç¥F.ListFiles ‚àÜPath,'\input\en\*.csv'
   ‚ÜíPassesIf oldTotal‚â¢newTotal
   oldTotal[;2]‚Üê‚çé¬®oldTotal[;2]
   newTotal[;2]‚Üê‚çé¬®newTotal[;2]
   ‚ÜíPassesIf oldTotal[;2]‚àß.‚â§newTotal[;2]

   (rc more)‚Üê‚àÜExecute_SC_Cmd'stop'
   ‚ÜíFailsIf 0‚â†rc
   ‚àÜPause 2
   (rc more)‚Üê‚àÜExecute_SC_Cmd'query'
   ‚ÜíFailsIf 0=‚à®/'STATE : 1 STOPPED'‚ç∑A.dmb more

   R‚Üê‚àÜOK
‚àá</code></pre>
<p>Though this test starts and stops the Service, its real purpose is to make sure that the Service processes input files as expected.</p>
<div class="h_tag">
<a href="#Running-the-tests" id="Running-the-tests" class="autoheader_anchor">
<h3>Running the tests</h3>
</a>
</div>
<p>First we need to ensure everything is assembled freshly, and with admin rights.</p>
<p>The best way to do that is to run the script <code>MakeService.dyapp</code> from a console that was started <em>with admin rights</em>. (Unfortunately you cannot right-click on a <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr> and select ‚ÄúRun as administrator‚Äù from the context menu.)</p>
<p>You must change the current directory in the console window to where the <abbr title="File with the extension 'dyapp' that contains 'Load' and 'Run' commands in order to put together an APL application">DYAPP</abbr> lives before actually calling it.</p>

<div class="leanpub_A">
<h3>Console with admin rights.</h3>
<p>The best way to start a console window with admin rights:</p>
<ol start="1">
<li>Press the Windows key.</li>
<li>Type <code>cmd</code>. If you wonder, ‚Äúwhere shall I type this into‚Äù don't worry - just type.</li>
<li>Right-click on <em>Command prompt</em> and select <em>Run as administrator</em>.</li>
</ol>
</div>

<p>A Dyalog instance is started. In the session you should see something similar to this:</p>
<pre><code>Booting C:\...\v13\MakeService.dyapp
Loaded: #.APLTreeUtils
Loaded: #.FilesAndDirs
Loaded: #.HandleError
Loaded: #.IniFiles
Loaded: #.OS
Loaded: #.Logger
Loaded: #.EventCodes
Loaded: #.Constants
Loaded: #.Utilities
Loaded: #.MyApp
Loaded: #.ServiceState
Loaded: #.Tester
Loaded: #.Execute
Loaded: #.WinSys
Loaded: #.TestsForServices
Loaded: #.ServiceHelpers
#.‚éïEX'ServiceHelpers'
Loaded: #.MakeService</code></pre>
<p>In the next step establish the test helpers by calling <code>#.TestsForServices.GetHelpers</code>.</p>
<p>Finally run <code>#.TestsForServices.RunDebug 0</code>. You should see something like this:</p>
<pre><code>#.TestsForServices.RunDebug 0
--- Test framework "Tester" version 3.3.0 from YYYY-MM-DD -----------------------------
Searching for INI file testcases_APLTEAM2.ini
  ...not found
Searching for INI file Testcases.ini
  ...not found
Looking for a function "Initial"...
*** Service MyAppService successfully installed
  "Initial" found and sucessfully executed
--- Tests started at YYYY-MM-DD hh:mm:dd on #.TestsForServices ------------------------
   Pausing for 2 seconds...
   Pausing for 2 seconds...
   Pausing for 2 seconds...
   Pausing for 2 seconds...
  Test_01 (1 of 2) : Start, pause and continue the service.
   Pausing for 2 seconds...
   Pausing for 2 seconds...
   Pausing for 2 seconds...
  Test_02 (2 of 2) : Start service, check results, give it some more work to do, check and stop it.
 --------------------------------------------------------------------------------------------------
   2 test cases executed
   0 test cases failed
   0 test cases broken
Time of execution recorded on variable #.TestsForServices.TestCasesExecutedAt in: YYYY-MM-DD hh:mm:ss
Looking for a function "Cleanup"...
  Function "Cleanup" found and sucessfully executed.
*** Tests done
</code></pre>
</body>
</html>