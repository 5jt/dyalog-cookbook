<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">
<title>Tasks</title>
<style media="screen">
html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;}body{margin:0;}article,aside,footer,header,nav,section{display:block;}h1{font-size:2em;margin:0.67em 0;}figcaption,figure,main{display:block;}figure{margin:1em 40px;}hr{box-sizing:content-box;height:0;overflow:visible;}pre{font-family:monospace, monospace;font-size:1em;}a{background-color:transparent;-webkit-text-decoration-skip:objects;}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted;}b,strong{font-weight:inherit;}b,strong{font-weight:bolder;}code,kbd,samp{font-family:monospace, monospace;font-size:1em;}dfn{font-style:italic;}mark{background-color:#ff0;color:#000;}small{font-size:0.8em;}sub,sup{font-size:0.75em;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}audio,video{display:inline-block;}audio:not([controls]){display:none;height:0;}img{border-style:none;}svg:not(:root){overflow:hidden;}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:1em;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button,html [type="button"], [type="reset"],[type="submit"]{-webkit-appearance:button;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{display:inline-block;vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details, menu{display:block;}summary{display:list-item;}canvas{display:inline-block;}template{display:none;}[hidden]{display:none;}body{margin:0;font-family:"Bookman Old Style", "Callisto MT", Bookman, "Goudy Old Style", Garamond, serif;background-color:#fdfdfd;font-size:18px;line-height:1.4;max-width:none;padding:0.83em;color:#292929;}h1, h2, h3, h4, h5, h6{color:#404040;font-weight:800;padding-left:0;}h1, h2, h3, h4, h5, h6{font-family:"Century Gothic", Verdana, "Sans";}h1, h2, h3, h4, p{margin-bottom:0.88em;}h1{font-size:1.8em;margin:0.27em 0 1.11em 0;}h1 > code, h2 > code, h3 > code, h4 > code, h5 > code, h6 > code{font-size:1em;background-color:inherit;}h2{font-size:1.44em;margin:0.55em 0 0.55em 0;padding-top:0.55em;border-bottom:1px solid Silver;}h3{margin:0;margin-top:0.55em;font-size:1.22em;}nav h3{font-size:0.88em;margin-left:0.83em;margin-bottom:0.27em;}h4{font-size:1em;margin:0;margin-top:0.55em;}h5{font-size:0.94em;margin:0;margin-top:0.66em;padding:0;}h6{font-size:0.88em;margin:0;margin-top:0.66em;padding:0;}a{color:#0099ff;margin:0;padding:0;vertical-align:baseline;}a:visited{color:purple;}a.autoheader_anchor{text-decoration:none;}ul{list-style-type:disc;}ul, ol{padding:0;margin:0;}dd{padding-top:0.25em;}p.first_dd{padding-top:0.25em;}li > ul, ol{padding-bottom:0;}li{line-height:1.3;margin-left:1.38em;margin-bottom:0.55em;}ul > li{margin-left:1.11em;}li ul{margin-left:0.55em;}li ul{margin-left:0.27em;}li p{padding:1px 0 0 0;margin:0.55em 0 0.27em 0;line-height:1.3;}p, ul, ol{line-height:1.3;padding:0.44em 0 0 0;margin:0;}pre{overflow:scroll;padding:0.55em 0.27em;margin:0.55em 0 0.55em 0 !important;background-color:#faebd7;color:#3e3e3e;border:1px Silver dashed;display:block;font-family:APLFont, monospace;font-weight:400;}pre > code{line-height:1.2;border:0;padding:0;margin:0;background-color:inherit;color:inherit;font-weight:inherit;}a code{padding:0;font-size:1em;}nav code{background-color:inherit;font-weight:400;color:inherit;}code{font-family:APLFont, monospace;background-color:#e7e7e7;color:Black;font-weight:800;line-height:1.2;font-size:0.88em;margin:0;color:#950000;padding:0 0.16em;}tbody tr:nth-child(even){background-color:#F0F0F0;}th{background-color:#E6E6E6;color:black;}th, td{padding:0.16em 0.55em;}table{border-color:Black;margin:1.11em 0 1.11em 0;border:2px black;border-collapse:collapse;font-family:APLFont;font-size:0.88em;line-height:1.2;border:1px solid Gray;}li > table{margin:0.55em 0 0.55em 0;}tr{margin:1.11em;}th{font-weight:bold;}tfoot td{font-weight:bold;}blockquote{border-left:0.27em solid silver;padding-left:0.27em;margin:0.83em 0.27em 0.83em 0.55em;}blockquote ul li{margin-left:1.38em;}blockquote ol li{margin-left:1.38em;}li > blockquote{margin-left:0;}nav{background-color:#f5f5f5;border:1px solid Black;padding:0.55em;margin:0.55em;margin-right:0;box-shadow:0.27em 0.27em 0.27em Gray;overflow:hidden;}nav#main_nav{position:fixed;top:0;right:0.55em;float:none;width:auto;}nav#main_nav_no_collapse li{font-size:0.77rem;}nav#main_nav_no_collapse li{line-height:1.5;}nav ul{list-style-type:none;margin:0 0 0.11em 0;padding:0;}nav a:visited{color:black;}nav ul li{margin-bottom:0.16em;}nav li p{margin:0;padding:0;line-height:1;margin:0;padding:0;}nav li{font-size:0.75rem;line-height:1.3;padding:0;margin-top:0;margin-bottom:0;margin-left:0.83em;}nav p{font-weight:bold;font-size:0.75rem;padding-top:0;}dl{margin-top:0.1em;margin-bottom:0.1em;}dt{margin-top:0.75em;margin-bottom:0.1em;font-weight:800;}label#hide_toc_label{font-size:0.8em;}.toc-container{position:relative;height:auto;}div.toc-container h1{font-size:0.88em;margin:0.27em 0 0.27em 0;}[type="checkbox"]{position:absolute;left:-9999px;}label{display:block;width:100%;height:1.1em;cursor:pointer;top:0;padding-left:1.1em;}label:before{content:'Table of contents \25BC';font-weight:bold;font-size:90%;padding-bottom:0;}[type="checkbox"] ~ div{display:none;}[type="checkbox"]:checked ~ div{display:block;margin-top:1.1em;}[type="checkbox"]:checked + label{top:100%;}[type="checkbox"]:checked + label:before{content:'Table of contents ▲';}div#footnotes_div p{line-height:1;padding-bottom:0;padding-top:0;}div#footnotes_div ol{padding-top:0;}@font-face{font-family:"APLFont";src:local("APL385 Unicode"), url("http://misc.aplteam.com/apl385.ttf") format("truetype");}.no_display{display:none;}.red{color:red;}img{margin-top:0.55em;margin-bottom:0.27em;}div.leanpub{padding:0.83em 0.55em 1.11em 0;margin:0.55em 0 0 0.27em;overflow:auto;}div.leanpub_A{border:1px solid black;background-color:#f1f1f1;padding:0.55em;margin:1.11em 0 0.83em 0;}div.leanpub h3, div.leanpub_A h3{font-size:1.2em;padding:0;margin:0;}div.leanpub h4, div.leanpub_A h4{font-size:1.1em;padding:0.27em 0 0 0;margin:0;}div.leanpub h5, div.leanpub h5{font-size:1.0em;padding:0.27em 0 0 0;margin:0;}div.leanpub_A h5, div.leanpub_A h5{font-size:1.0em;padding:0.27em 0 0 0;margin:0;}div.leanpub img{padding:0;margin:0 1.11em 0.27em 0;}div.leanpub_A > p:first-child{padding-top:0;margin-top:0;}div.leanpub img{float:left;padding:0;margin:0.55em 1.11em 0 0;clear:both;}div.leanpub tbody *{background-color:transparent;}div.leanpub p{padding:0.17em 0 0 0;margin:0;}span.leanpub_code{color:Red;}div.leanpub p{display:block;padding:0.44em 0 0 0;}div.leanpub > div{margin-left:2.27em;}
</style>
<style media="print">
@page{margin:25mm 20mm 25mm 20mm;}body{font-family:"Bookman Old Style", "Callisto MT", Bookman,"Goudy Old Style", Garamond, serif;font-size:9pt;line-height:1.2;}h1{font-size:170%;}h2{font-size:110%;}h3{font-size:110%;}h4{font-size:105%;}h5{font-size:100%;}h6{font-size:95%;}h1{margin:0 0 20pt 0;}h2{margin:15pt 0 3pt 0;}h3{margin:10pt 0 0pt 0;}h4{margin:10pt 0 0pt 0;}h5{margin:9pt 0 0pt 0;}h6{margin:9pt 0 0pt 0;}h1, h2, h3, h4, h5, h6{color:black;font-family:"Century Gothic", Verdana, "Sans";page-break-after:avoid;}h1 > code, h2 > code, h3 > code, h4 > code, h5 > code, h6 > code{font-size:100%;}h2{border-bottom:1pt solid Silver;padding-bottom:2pt;}.h_tag{page-break-after:avoid;break-after:avoid;}abbr[title]{border-bottom:0;text-decoration:none;}a{color:black;margin:0;padding:0;vertical-align:baseline;text-decoration:none;font-style:italic;}a.autoheader_anchor{text-decoration:none;font-style:normal;page-break-after:avoid;break-after:avoid;}ul{list-style-type:square;}ul, ol{padding:0;margin:0;}li > ul, ol{padding-bottom:0;}li{line-height:1.3;margin-left:13pt;margin-bottom:5pt;}ul > li{margin-left:10pt;}li ul{margin-left:5pt;}li ul{margin-left:3pt;}li p{padding:1pt 0 0 0;margin:5pt 0 3pt 0;line-height:1.3;}p, ul, ol{line-height:1.3;padding:4pt 0 0 0;margin:0;color:black;}pre{padding:3pt;margin:5pt 0;white-space:pre-wrap;background-color:#FAFAFA;border:1pt Silver solid;display:block;font-family:APLFont, monospace;page-break-inside:avoid;-webkit-print-color-adjust:exact;}pre code{background-color:#FAFAFA;color:Black;padding:0;margin:0 0 -6pt 0;line-height:1.1;border:0;}code{font-family:APLFont, monospace;line-height:1.2;font-size:9pt;padding:3pt 1pt 3pt 1pt;color:#950000;padding:3pt 4pt 3pt 4pt;}tbody th, tfoot tr{background-color:#e6e6e6;}tbody tr:nth-child(even){background-color:#fafafa;}th{background-color:#F0F0F0;}th, td{padding:1pt 5pt;}table{margin:10pt 0;font-family:APLFont;font-size:9pt;padding:0;border:1pt solid silver;-webkit-print-color-adjust:exact;}li > table{margin:10pt 0 10pt 0;}tr{margin:20pt;}th{font-weight:bold;}tfoot td{font-weight:bold;}blockquote{border-left:5pt solid silver;padding-left:5pt;margin:8pt 3pt 8pt 8pt;}nav{background-color:#f8f8f8;border:1pt solid Gray;width:auto;float:right;padding:5pt 5pt 5pt 0;margin:5pt 0 5pt 5pt;page-break-inside:avoid;}nav *{font-size:75%;}nav ul{list-style-type:none;margin:0 0 2pt 0;padding:0;}nav ul li{margin-bottom:0;}nav li p{margin:0;padding:0;line-height:1;margin:0;padding:0;}nav li{font-size:9pt;line-height:1;padding:0;margin-top:0;margin-bottom:0;margin-left:8pt;}dl{margin-top:0;margin-bottom:10pt;}dt{margin-top:10pt;margin-bottom:0;font-weight:800;page-break-inside:avoid;}dd{margin-top:2pt;}label#hide_toc_label{font-size:65%;}.toc-container{position:relative;height:auto;margin-top:5pt;}.toc-container h1{margin:0 0 7pt 7pt;}[type="checkbox"]{display:none;}label{display:block;width:100%;height:1.1em;top:0;padding-left:10pt;}label:before{content:'Table of contents';font-weight:bold;font-size:140%;padding-bottom:10pt;}a.external_link::before{content:" 🌎";}a.bookmark_link::before{content:" ➯";}a.mailto_link::before{content:" ✉"}nav a.bookmark_link{font-style:normal;}nav p{margin-left:10pt;font-weight:bold;font-size:9pt;}nav a{font-style:normal;}nav a.bookmark_link::before{content:"";}div#footnotes_div a::before{content:"";}div#footnotes_div a{font-style:normal;}div#footnotes_div{page-break-inside:avoid;}@font-face{font-family:"APLFont";src:local("APL385 Unicode"), url("http://misc.aplteam.com/apl385.ttf") format("truetype");}.no_print{display:none;}.red{color:red;}.avoid_page_break{page-break-inside:avoid;}.page_break_before{page-break-before:auto;}div.leanpub{margin:10pt 0 10pt 8pt;page-break-inside:avoid;}div.leanpub_A{border:1pt solid black;background-color:#f9f9f9;padding:5pt;margin:10pt 0 10pt 0;page-break-inside:avoid;}div.leanpub h3, div.leanpub_A h3{font-size:1.2em;padding:3pt 0 0 0;margin:0;}div.leanpub h4, div.leanpub_A h4{font-size:1.1em;padding:3pt 0 0 0;margin:0;}div.leanpub h5, div.leanpub h5{font-size:1.0em;padding:3pt 0 0 0;margin:0;}div.leanpub_A h5, div.leanpub_A h5{font-size:1.0em;padding:3pt 0 0 0;margin:0;}div.leanpub img{padding:0;margin:0 10pt 2pt 0;}div.leanpub_A > p:first-child{padding-top:0;margin-top:0;}div.leanpub > div > h1:first-child{padding-top:5pt;}div.leanpub img{float:left;padding:0;margin:5pt 10pt 0 0;clear:both;}div.leanpub p{padding:3pt 0 0 0;margin:0;}span.leanpub_code{color:black;}div.leanpub p{display:block;padding:8pt 0 0 0;}div.leanpub > div{margin-left:35pt;}
</style>
<meta name="author" content="kai">
</head>
<body>
<nav id="main_nav_no_collapse">
<div class="toc-container">
<h3>Table of contents</h3>
<ul>
<li><a href="#What-is-a-Scheduled-Task">What is a Scheduled Task?</a></li>
<li><a href="#What-can-and-cannot-be-achieved-by-Scheduled-Tasks">What can and cannot be achieved by Scheduled Tasks</a></li>
<li><a href="#Scheduled-Tasks-versus-Services">Scheduled Tasks versus Services</a></li>
<li><a href="#Preconditions-for-a-Scheduled-Task">Preconditions for a Scheduled Task</a></li>
<li><a href="#Precautions-ensure-one-instance-only">Precautions: ensure one instance only</a></li>
<li><a href="#Create-a-Scheduled-Task">Create a Scheduled Task</a>
<ul>
<li><a href="#Start-the-Scheduler">Start the Scheduler</a>
<ul>
<li><a href="#The-General-tab">The General tab</a></li>
<li><a href="#The-Trigger-tab">The Trigger tab</a></li>
<li><a href="#The-Action-tab">The Action tab</a></li>
<li><a href="#The-Conditions-tab">The Conditions tab</a></li>
<li><a href="#The-Settings-tab">The Settings tab</a></li>
</ul></li>
<li><a href="#Running-a-Scheduled-Task">Running a Scheduled Task</a></li>
</ul></li>
<li><a href="#Tips-tricks-pratfalls">Tips, tricks, pratfalls</a>
<ul>
<li><a href="#Riding-into-a-Scheduled-Task">Riding into a Scheduled Task</a></li>
<li><a href="#The-Task-Scheduler-GUI">The Task Scheduler GUI</a></li>
<li><a href="#Re-make-MyApp">Re-make MyApp</a></li>
<li><a href="#MyApp-crashes-with-return-code-32">MyApp crashes with return code 32</a></li>
<li><a href="#Binding-MyAPP-with-the-Dyalog-development-EXE">Binding MyAPP with the Dyalog development EXE</a></li>
<li><a href="#Your-application-doesnt-do-what-its-supposed-to-do">Your application doesn’t do what it’s supposed to do</a></li>
<li><a href="#Task-Scheduler-error-codes">Task Scheduler error codes</a></li>
</ul></li>
<li><a href="#Creating-tasks-programmatically">Creating tasks programmatically</a>
</ul>
</div>
</nav>
<div class="h_tag">
<a href="#Scheduled-Tasks" id="Scheduled-Tasks" class="autoheader_anchor">
<h1>Scheduled Tasks</h1>
</a>
</div>
<div class="h_tag">
<a href="#What-is-a-Scheduled-Task" id="What-is-a-Scheduled-Task" class="autoheader_anchor">
<h2>What is a Scheduled Task?</h2>
</a>
</div>
<p>Windows offers a task scheduler in order to run applications at specific times. Like Services, Scheduled Tasks are designed for background jobs, meaning that such applications have no GUI, in fact, <em>cannot</em> have a GUI.</p>
<p>The Scheduler allows you to start the application on a specific date and time once, or every day, every week or every month. The user does not have to be logged on (that’s different in older versions of Windows) and it let you run an application in elevated mode (see below).</p>
<div class="h_tag">
<a href="#What-can-and-cannot-be-achieved-by-Scheduled-Tasks" id="What-can-and-cannot-be-achieved-by-Scheduled-Tasks" class="autoheader_anchor">
<h2>What can and cannot be achieved by Scheduled Tasks</h2>
</a>
</div>
<p>Scheduled Tasks – like Services – are perfect for background tasks. Examples are:</p>
<ul>
<li>Take a backup once a week</li>
<li>Check the availability of your website once every hour</li>
<li>Send a test email to all your email addresses once a week</li>
</ul>
<p>Scheduled Tasks cannot interact with the user: when you try to put up a GUI and ask a question nothing appears on the screen: you just can’t do it.</p>
<div class="h_tag">
<a href="#Scheduled-Tasks-versus-Services" id="Scheduled-Tasks-versus-Services" class="autoheader_anchor">
<h2>Scheduled Tasks versus Services</h2>
</a>
</div>
<p>If your application needs to run all the time, even with delays between actions, then running as a Service would be more appropriate. Services are typically started automatically when the machine is booted, and they typically keep running until the next boot.</p>
<p>To make this point clear, imagine these two scenarios:</p>
<ul>
<li>You need an application to start once a week and take a backup of a specific folder.</li>
<li>You need an application to constantly monitor a specific folder for certain file types (say Markdown) and convert them (say into <abbr title="Hyper Text Mark-up language">HTML</abbr> files).</li>
</ul>
<p>The former is clearly a candidate for a Scheduled Task while the latter is a candidate for a Service.</p>
<div class="h_tag">
<a href="#Preconditions-for-a-Scheduled-Task" id="Preconditions-for-a-Scheduled-Task" class="autoheader_anchor">
<h2>Preconditions for a Scheduled Task</h2>
</a>
</div>
<p>You need either a saved workspace with <code>⎕LX</code> set or an <abbr title="Executable file with the extension 'exe'">EXE</abbr> created from a workspace. An <abbr title="Executable file with the extension 'exe'">EXE</abbr> has two advantages compared with an ordinary workspace:</p>
<ol start="1">
<li>The user cannot investigate the code.</li>
<li>Dyalog is not required on the target system, not even the Runtime <abbr title="Executable file with the extension 'exe'">EXE</abbr>.</li>
</ol>
<p>If neither of these concerns you, an <abbr title="Executable file with the extension 'exe'">EXE</abbr> has no advantages over a simple saved workspace; it just adds complexity and should be avoided if there aren’t any advantages. However, if you cannot be sure the required version of Dyalog is installed on the target machine then it must be a stand-alone <abbr title="Executable file with the extension 'exe'">EXE</abbr>.</p>
<p>We have already taken care of handling errors and writing to log files, which are the only sources of information in general, and in particular for analysing any problems that pop up when a Scheduled Task runs, or crashes. In other words, we are ready to go.</p>
<p>Our application is an obvious candidate for running as a Service, but we can still run it as a Scheduled Task, so let’s explore that way.</p>
<div class="h_tag">
<a href="#Precautions-ensure-one-instance-only" id="Precautions-ensure-one-instance-only" class="autoheader_anchor">
<h2>Precautions: ensure one instance only</h2>
</a>
</div>
<p>Dealing with Scheduled Tasks you usually don’t want more than one instance of the application running at the same time. One of the most common sources of difficulty investigating Scheduled Tasks turns out to be running a second instance.</p>
<p>For example, you try to ride into it but the port used by Ride is already occupied by an instance started earlier without you knowing of it. We are going to prevent this happening.</p>

<div class="leanpub_A">
<p>In the rare circumstances when you want application instances managed by the Task Scheduler to run in parallel, establish a mechanism that allows you to enforce having just one instance running, if only for debugging purposes. Make it an <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> entry (like <code>AllowMultipleInstances</code>) and document it appropriately.</p>
</div>

<p>We resume, as usual, by saving a copy of <code>Z:\code\v11</code> as <code>Z:\code\v12</code>.</p>
<p>In order to force the application to run only once at any given time we add a function <code>CheckForOtherInstances</code> to <code>MyApp.dyalog</code>:</p>
<pre><code>∇ {tno}←CheckForOtherInstances dummy;filename;listOfTiedFiles;ind
 ⍝ Attempts to tie the file "MyAppCtrl.dcf" exclusively and returns the tie number.
 ⍝ If that is not possible then an error is thrown because we can assume that the
 ⍝ application is already running.\\
 ⍝ Notes:
 ⍝ * In case the file is already tied it is untied first.
 ⍝ * If the file does not exist it is created.
   filename←'MyAppCtrl.dcf'
   :If 0=F.IsFile filename
       tno←filename ⎕FCREATE 0
   :Else
       :If ~0∊⍴⎕FNUMS
           listOfTiedFiles←A.dtb↓⎕FNAMES
           ind←listOfTiedFiles⍳⊂filename
       :AndIf ind≤⍴⎕FNUMS
           ⎕FUNTIE ind⊃⎕FNUMS
       :EndIf
       :Trap 24
           tno←filename ⎕FTIE 0
       :Else
           'Application is already running'⎕SIGNAL C.APP_STATUS.ALREADY_RUNNING
       :EndTrap
   :EndIf
∇</code></pre>
<p>Notes:</p>
<ul>
<li>First we check whether the file <code>MyAppCtrl.dcf</code> exists. If not, we create it and the job is done: creating a file implies an exclusive tie.</li>
<li>If it does exist we check whether it is tied by itself, in case we are developing and have restarted the application without having closed it down properly. We then untie the file.</li>
<li>Finally we attempt to tie the file exclusively but trap error 24 – that’s FILE TIED. In that case we signal an error <code>Constants.APP_STATUS.ALREADY_RUNNING</code>.</li>
<li>The file is expected (or will be created) in the current directory.</li>
</ul>
<p>Since this function will signal an error <code>Constants.APP_STATUS.ALREADY_RUNNING</code> we need to add this to the <code>EXIT</code> namespace in <code>MyApp</code>:</p>
<pre><code>:Namespace EXIT
...
        UNABLE_TO_WRITE_TARGET←114
<span class="leanpub_code">        ALREADY_RUNNING←115
</span>          GetName←{
        ....
:EndNamespace</code></pre>
<p>We change <code>Initial</code> so that it calls this new function:</p>
<pre><code>∇ (Config MyLogger)←Initial dummy
...
   Config←CreateConfig ⍬
<span class="leanpub_code">   Config.ControlFileTieNo←CheckForOtherInstances ⍬
</span>   CheckForRide Config.(Ride WaitForRide)
...
∇</code></pre>
<p>We want to untie the file as well. So far we have not paid any attention to how to close the application down properly; now we take this opportunity to introduce a function <code>Cleanup</code> which does that:</p>
<pre><code>∇ {r}←Cleanup
   r←⍬
   ⎕FUNTIE Config.ControlFileTieNo
   Config.ControlFileTieNo←⍬
∇

:EndNamespace</code></pre>
<p>Of course we have to call <code>Cleanup</code> from somewhere:</p>
<pre><code>∇ {r}←StartFromCmdLine arg;MyLogger;Config;rc;⎕TRAP
 ...
   rc←TxtToCsv arg~''''
<span class="leanpub_code">   Cleanup
</span>   Off rc
∇</code></pre>
<p>After all these changes it’s time to execute our test cases. Execute <code>#.Tests.Run</code>.</p>
<p>Turns out that two of them fail! The reason: when we run <code>Test_exe_01</code> and <code>Test_exe_02</code> the control file is already tied. That’s because <code>Test_TxtToCsv</code> runs first, and it calls <code>Initial</code> – which ties the control file – but not <code>Cleanup</code>, which would untie it. The fix is simple: we need to call <code>Cleanup</code> in the test. However, we can’t just do this at the end of <code>Test_TxtToCsv_01</code>:</p>
<pre><code>∇ R←Test_TxtToCsv_01(stopFlag batchFlag);⎕TRAP;rc
...
   →FailsIf rc≢##.MyApp.EXIT.SOURCE_NOT_FOUND
   #.MyApp.Cleanup ⍬
   R←∆OK
∇</code></pre>
<p>If we do this then <code>Cleanup</code> would not be called if the check fails. Let’s do it properly instead:</p>
<pre><code>∇ R←Test_TxtToCsv_01(stopFlag batchFlag);⎕TRAP;rc
...
   →GoToTidyUp rc≢##.MyApp.EXIT.SOURCE_NOT_FOUND
   R←∆OK
  ∆TidyUp:
   ##.MyApp.Cleanup ⍬</code></pre>

<div class="leanpub">
<img src="https://download.aplwiki.com/LeanPub/Images/information.png" alt="Information">
<div>
<p>Note that we must call <code>MyApp.Cleanup</code> rather than just <code>Cleanup</code> because we are at that moment in <code>Tests</code> – and we don’t want to execute <code>Tests.Cleanup</code>!</p>
</div>
</div>

<p>We can learn some lessons from the failure of those two test cases:</p>
<ol start="1">
<li>The sequence in which the tests are executed can have an impact on whether tests fail or not. If <code>Test_TxtToCsv</code> had been the last test case, the problem would have slipped through undetected.</li>
<li>That a test suite runs through OK does not necessarily mean it will keep doing so when you execute it again. If <code>Test_TxtToCsv</code> had been the very last test case the test suite would have passed without a problem but an attempt to run it again would fail because now the control file would have been tied, and <code>Test_exe_01</code> would have failed.</li>
</ol>
<p>In our specific case it was actually a problem in the test cases, <em>not</em> in <code>MyApp</code>, but the conclusion stands anyway.</p>

<div class="leanpub_A">
<h3>Shuffle test cases</h3>
<p>At the time of writing (2017-07) the sequence of the test cases relies on alphabetical order and is therefore predictable. On the to-do list for the <code>Tester</code> class is a topic: Add an option that makes the test framework shuffle the test cases so that the order of execution is not predictable anymore.</p>
</div>

<div class="h_tag">
<a href="#Create-a-Scheduled-Task" id="Create-a-Scheduled-Task" class="autoheader_anchor">
<h2>Create a Scheduled Task</h2>
</a>
</div>
<div class="h_tag">
<a href="#Start-the-Scheduler" id="Start-the-Scheduler" class="autoheader_anchor">
<h3>Start the Scheduler</h3>
</a>
</div>
<p>Press the Win key and type Scheduler. Select <em>Task Scheduler</em> from the list. You will see:</p>
<p><img src="Images/scheduler_01.png" alt="The Windows Task Scheduler" title="The Windows Task Scheduler"></p>
<p>First check whether the fifth point in the <em>Actions</em> pane on the right reads <em>Disable All Tasks History</em>. If it does not you won’t get any details about a Scheduled Task.</p>
<p>The arrow points to the <em>Create Task</em> command – click it.</p>
<p><img src="Images/scheduler_02.png" alt="Create Task" title="Create Task"></p>
<div class="h_tag">
<a href="#The-General-tab" id="The-General-tab" class="autoheader_anchor">
<h4>The General tab</h4>
</a>
</div>
<dl>
<dt><em>Name</em></dt>
<dd>Used in the list presented by the Task Scheduler.</dd>
<dt><em>Description</em></dt>
<dd>Shown in the list presented by the Task Scheduler. Keep it concise.</dd>
<dt><em>Run only when the user is logged on</em></dt>
<dd>You will almost certainly change this to <em>Run whether the user is logged on or not</em>.</dd>
<dt><em>Do not store a password</em></dt>
<dd>The password is stored safely, so there is no reason not to provide it.</dd>
<dt><em>Running with highest privileges</em></dt>
<dd><p class="first_dd">Unfortunately this check box is offered whether your user account has admin rights or not. If it does not, then ticking the box won’t have any effect.</p></dd>
<dd><p>If your user account has no admin rights but your Scheduled Task needs to run with highest privileges then you need to specify a different user id/password after clicking the <em>Change user or group</em> button.</p></dd>
<dd><p>Whether your application needs to run with highest privileges or not is impossible to say. Experience shows that sometimes a process that fails when – and only when – the application runs as a Scheduled Task will work fine if run as a Schedule Task with highest privileges, although it is by no means clear what those rights are required for.</p></dd>
<dt><em>Configure for</em></dt>
<dd>Generally you should select the OS the task is running on.</dd>
</dl>
<div class="leanpub_A">
<h3>UAC, admin rights and all the rest</h3>
<p>With UAC (User Account Control), users of the admin group have 2 tokens. The filtered token represents standard user rights.</p>
<p>This token is used by default, for example when you create a shell (a console). Therefore you have just standard user rights by default even when using a user account with admin rights. However, when you have admin rights and you click an <abbr title="Executable file with the extension 'exe'">EXE</abbr> and select <em>Run as administrator</em>, the full token is used, which contains admin rights.</p>
<p>Notes:</p>
<ul>
<li>Some applications ask for admin rights even when you do not right-click on the <abbr title="Executable file with the extension 'exe'">EXE</abbr> and select <em>Run as administrator</em>; the Registry Editor and the Task Manager are examples.</li>
<li>Even if you run an application with admin rights (sometimes called <em>in elevated mode</em>) it does not mean that the application can do whatever it likes, but as an admin you can always grab any missing rights.</li>
<li>Remote filesystems are unlikely to be visible; you need to mount them again.</li>
</ul>
</div>

<div class="h_tag">
<a href="#The-Trigger-tab" id="The-Trigger-tab" class="autoheader_anchor">
<h4>The Trigger tab</h4>
</a>
</div>
<p>The tab holds no mysteries.</p>
<div class="h_tag">
<a href="#The-Action-tab" id="The-Action-tab" class="autoheader_anchor">
<h4>The Action tab</h4>
</a>
</div>
<p>After clicking <em>New</em> this is what you get:</p>
<p><img src="Images/scheduler_03.png" alt="New Action" title="New Action"></p>
<p>Make sure you use the <em>Browse</em> button to navigate to the <abbr title="Executable file with the extension 'exe'">EXE</abbr>/<abbr title="Executable file that contains batch commands">BAT</abbr>/whatever you want to run as a Scheduled Task. This avoids typos.</p>
<dl>
<dt><em>Add arguments</em></dt>
<dd>allows you to specify something like <code>MAXWS=345M</code> or the name of a workspace in case <em>Program</em> is not an <abbr title="Executable file with the extension 'exe'">EXE</abbr> but a Dyalog interpreter. In particular, you should add <code>DYALOG_NOPOPUPS=1</code>. This prevents any dialogs from popping up (aplcore, <abbr title="Short for Workspaces">WS</abbr> FULL, etc.). You don’t want them when Dyalog is running in the background because there's nobody around to click the <em>OK</em> button…</dd>
<dt><em>Start in</em></dt>
<dd><p class="first_dd">is useful for specifying what will become the current (or working) directory for the running program. We recommend setting the current directory in your code as early as possible, so you don’t really need to set this here except that when you don’t you might well get an error code 2147942512.</p></dd>
<dd><p>We will discuss later how such error codes can be interpreted, but for the time being, trust us that it actually means <em>Not enough space available on the disk</em>! When you do specify the <em>Start in</em> parameter it runs just fine.</p></dd>
<dd><p>However, you <em>must not delimit</em> the path with double-quotes. It’s understandable that Microsoft does not require them in this context because by definition any blanks are part of the path, but why they do not just ignore them when specified is less understandable.</p></dd>
</dl>
<div class="h_tag">
<a href="#The-Conditions-tab" id="The-Conditions-tab" class="autoheader_anchor">
<h4>The Conditions tab</h4>
</a>
</div>
<p>The tab holds no mysteries.</p>
<div class="h_tag">
<a href="#The-Settings-tab" id="The-Settings-tab" class="autoheader_anchor">
<h4>The Settings tab</h4>
</a>
</div>
<p>Unless you have a very good reason not to, <em>Allow task to be run on demand</em>, which means you have the <em>Run</em> command available on the context menu.</p>
<p>Note you may specify restart parameters in case the task fails. Whether that makes any sense depends on the application.</p>
<p>The combo box at the bottom allows you to select <em>Stop the existing instance</em>, which can be quite useful when debugging the application.</p>
<div class="h_tag">
<a href="#Running-a-Scheduled-Task" id="Running-a-Scheduled-Task" class="autoheader_anchor">
<h3>Running a Scheduled Task</h3>
</a>
</div>
<p>To start the task, right-click on it in the Task Scheduler and select <em>Run</em> from the context menu. Then check the log file. We have tested the application well, we know it works, so you should see a log file that contains something like this:</p>
<pre><code>2017-03-31 10:03:35 *** Log File opened
2017-03-31 10:03:35 (0) Started MyApp in ...\code\v12\MyApp
2017-03-31 10:03:35 (0)  ...\code\v12\MyApp\MyApp.exe MAXWS=370M
2017-03-31 10:03:35 (0)  Accents            ÁÂÃÀÄÅÇÐÈÊËÉÌÍÎÏÑÒÓÔÕÖØÙÚÛÜÝ  AAAAAA...
2017-03-31 10:03:35 (0)  ControlFileTieNo   1
2017-03-31 10:03:35 (0)  Debug              0
2017-03-31 10:03:35 (0)  DumpFolder         C:\Users\kai\AppData\Local\MyApp\Errors
2017-03-31 10:03:35 (0)  ForceError         0
2017-03-31 10:03:35 (0)  LogFolder          C:\Users\kai\AppData\Local\MyApp\Log
2017-03-31 10:03:35 (0)  Ride               0
2017-03-31 10:03:35 (0)  Trap               1
2017-03-31 10:03:35 (0) Source: MAXWS=370M
2017-03-31 10:03:35 (0) *** ERROR RC=112; MyApp is unexpectedly shutting down: SOURCE_NOT_FOUND</code></pre>
<p>Since we have not provided a filename, <code>MyApp</code> assumed that <code>MAXWS=370M</code> would be the filename. Since that does not exist the application quits with a return code <code>SOURCE_NOT_FOUND</code>, which is exactly proper.</p>
<p>However, from experience we know the likelihood of the task <em>not</em> running as intended is high. We have already discussed some of the issues that might pop up, and we will now discuss some more we have enjoyed over the years.</p>
<div class="h_tag">
<a href="#Tips-tricks-pratfalls" id="Tips-tricks-pratfalls" class="autoheader_anchor">
<h2>Tips, tricks, pratfalls</h2>
</a>
</div>
<div class="h_tag">
<a href="#Riding-into-a-Scheduled-Task" id="Riding-into-a-Scheduled-Task" class="autoheader_anchor">
<h3>Riding into a Scheduled Task</h3>
</a>
</div>
<p>Suppose you want to Ride into a Scheduled Task. So in the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> you set the <code>[Ride]Active</code> flag to <code>1</code>. While the Windows Firewall has still no rules for both this port and this application you <em>won’t</em> see the usual message when you run the application for the very first time, assuming that you use a user ID with admin rights:</p>
<p><img src="Images/Firewall_01.jpg" alt="Windows Firewall" title="Windows Firewall"></p>
<p>The application would start, seemingly run for a short period of time and then stop again without leaving any traces: no error codes, no log files, no crash files, nothing.</p>
<p>It is different when you simply double-click the <code>MyApp.exe</code>: in that case the <em>Security Alert</em> dialog box pops up, giving you an easy way to create a rule that allows the application to communicate via the given port.</p>
<p>By the way, when you click <em>Cancel</em> in the <em>Security Alert</em> dialog box, you might expect the Windows Firewall to deny access to the port but not create a rule either. You would be mistaken. The two buttons <em>Allow access</em> and <em>Cancel</em> shouldn’t be buttons at all! Instead there should be a group <em>Create rule</em> with two radio buttons: <em>Allow access</em> and <em>Deny access</em>.</p>
<p>If the user clicks the “Cancel” button a message <em>should</em> pop up saying that although no rule will be created, access to the port in question is denied. That would imply that when the application is started again the <em>Security Alert</em> dialog box will reappear.</p>
<p>Instead, when <em>Cancel</em> is clicked a blocking rule for that combination of application and port number is created, and you will not see that dialog box again for this combination.</p>
<p>The solution is to edit the Firewall rules. For that search for “Firewall”, run “Windows Defender Firewall” and then click on “Advanced settings”. You can then remove the blocking rule and define an exception.</p>
<div class="h_tag">
<a href="#The-Task-Scheduler-GUI" id="The-Task-Scheduler-GUI" class="autoheader_anchor">
<h3>The Task Scheduler GUI</h3>
</a>
</div>
<p>Once you have executed the <em>Run</em> command from the context menu the GUI changes the status from <em>Ready</em> to <em>Running</em>. That’s fine. Unfortunately it doesn’t change automatically back to <em>Ready</em> once the job has finished, at least not at the time of writing (2017-03) under Windows 10. For that you have to refresh with F5.</p>
<div class="h_tag">
<a href="#Re-make-MyApp" id="Re-make-MyApp" class="autoheader_anchor">
<h3>Re-make MyApp</h3>
</a>
</div>
<p>When you’ve found a bug and run <code>MyApp</code>’s <code>Make.bat</code> again, remember that this will overwrite the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr>. So if you’ve changed, say, Ride’s <code>Active</code> flag in the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr> from <code>0</code> to <code>1</code>, it will be <code>0</code> again after the call to <code>Make.bat</code>, and any attempt to Ride into the <abbr title="Executable file with the extension 'exe'">EXE</abbr> will fail. Easy to overlook!</p>
<div class="h_tag">
<a href="#MyApp-crashes-with-return-code-32" id="MyApp-crashes-with-return-code-32" class="autoheader_anchor">
<h3>MyApp crashes with return code 32</h3>
</a>
</div>
<p>If you see this you most probably forgot to copy over the DLLs needed by Ride [<a href="#fnref1" class="footnote_link"><sup>1</sup></a>] itself. That’s what triggers the return code 32 which means <em>File not found</em>.</p>

<div class="leanpub_A">
<h3>Windows return codes</h3>
<p>To translate a Windows return code like 32 into a more meaningful piece of information, download and install the user command <code>GetMsg</code> from the APL wiki. Then you can do this:</p>
<pre><code>      ]GetMsgFrom 32
The process cannot access the file because it is being used by another process.</code></pre>
<p>Sadly, the error messages are not always that helpful. The above message appears if you try to switch on Ride in an application, and the interpreter cannot find the DLLs that Ride needs.</p>
</div>

<div class="h_tag">
<a href="#Binding-MyAPP-with-the-Dyalog-development-EXE" id="Binding-MyAPP-with-the-Dyalog-development-EXE" class="autoheader_anchor">
<h3>Binding MyAPP with the Dyalog development EXE</h3>
</a>
</div>
<p>If for some reason you’ve created <code>MyApp.exe</code> by binding the application to the development version of Dyalog rather than the runtime (you can do this by providing a 0 as left argument to the <code>MakeExport</code> function) then you might run into a problem. Our code notices whether it is running under a development <abbr title="Executable file with the extension 'exe'">EXE</abbr> or a runtime <abbr title="Executable file with the extension 'exe'">EXE</abbr>. Error trapping will be inactive (unless it is enforced via the <abbr title="File with the extension 'ini' containing configuration data">INI</abbr>) and <code>⎕OFF</code> won’t be executed; instead it would execute <code>→</code> and hang around but without you being able to see the session.</p>
<p>So don’t do this. Because you have Ride at your disposal the development version has no advantages over the runtime <abbr title="Executable file with the extension 'exe'">EXE</abbr> anyway.</p>
<div class="h_tag">
<a href="#Your-application-doesnt-do-what-its-supposed-to-do" id="Your-application-doesnt-do-what-its-supposed-to-do" class="autoheader_anchor">
<h3>Your application doesn’t do what it’s supposed to do</h3>
</a>
</div>
<p>… but only when running as a task. Start the Task Scheduler and go to the <em>History</em> tab; if this is empty then you have not clicked <em>Enable all tasks history</em> as suggested earlier.</p>
<p>Don’t get fooled by <em>Action completed</em> and <em>Task completed</em> – they don’t tell you whether a task failed or not. Click <em>Action completed</em>: at the bottom you get information regarding that run. You might read something like:</p>
<pre><code>Task Scheduler successfully completed task "\MyApp" , instance "{c7cb733a-be97-4988-afca-a551a7907918}" , action "...\code\v12\MyApp\MyApp.exe" with return code 2147942512.</code></pre>
<p>That tells you task did not run at all. You won’t find either a log file or a crash file, and you cannot Ride into the application.</p>
<p>You need to analyze the return code provided. This is discussed next.</p>
<div class="h_tag">
<a href="#Task-Scheduler-error-codes" id="Task-Scheduler-error-codes" class="autoheader_anchor">
<h3>Task Scheduler error codes</h3>
</a>
</div>
<p>If the Task Scheduler itself throws an error you will find the error codes of little value – at first sight.</p>
<p>You can provoke such an error quite easily: edit the task we’ve created and change the contents of the <em>Program/script</em> field in the <em>Edit action</em> dialog to something that does not exist, so the Task Scheduler won’t find such a program to run. Then issue the <em>Run</em> command from the context menu.</p>
<p>Update the GUI by pressing F5 and you will see that errors are reported. The row that reads <code>Task Start Failed</code> in the <em>Task Category</em> columns and <code>Launch Failure</code> in the <em>Operational Code</em> columns is the one we are interested in. When you click on this row you will find that it reports an <code>Error Value 2147942402</code>. What exactly does this mean?</p>
<p>One way to find out is to google for 2147942402. For this particular error this will certainly do, but sometimes you will have to go through plenty of pages when people managed to produce the same error code in very different circumstances, and it can be quite time-consuming to find a page that carries useful information for <em>your</em> circumstances.</p>
<p>Instead we use the user command [<a href="#fnref3" class="footnote_link"><sup>3</sup></a>] <code>Int2Hex</code>, based on code written and contributed by Phil Last [<a href="#fnref2" class="footnote_link"><sup>2</sup></a>]. With this user command we can convert the value 2147942402 into a hex value:</p>
<pre><code>      ]Int2Hex 2147942402
80070002</code></pre>

<div class="leanpub_A">
<h3>Third-party user commands</h3>
<p>There are many useful third-party user commands available. For details how to install them see “<a href="./51 Appendix 2 — User commands.html" class="external_link">Appendix 2 — User commands</a>”.</p>
</div>

<p>The first four digits, 8007, mean that what follows is a Win32 status code. The last 4 are the status code. This is a number that needs to be converted into decimal:</p>
<pre><code>      ]Hex2Int 0002</code></pre>
<p>but in our case that is of course not necessary because the number is so small that there is no difference between hex and integer anyway, so we can convert it into an error message straight away.</p>
<p>Again we use a user command that is not part of a standard Dyalog installation but because it is so useful we strongly recommend installing it [<a href="#fnref4" class="footnote_link"><sup>4</sup></a>]. It translates a Windows error code into meaningful text.</p>
<pre><code>      ]GetMsgFrom
The system cannot find the file specified.</code></pre>
<p>And that’s why it failed.</p>
<div class="h_tag">
<a href="#Creating-tasks-programmatically" id="Creating-tasks-programmatically" class="autoheader_anchor">
<h2>Creating tasks programmatically</h2>
</a>
</div>
<p>It is possible to create Scheduled Tasks by a program, although this is beyond the scope of this book. See</p>
<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb736357(v=vs.85).aspx" class="external_link">https://msdn.microsoft.com/en-us/library/windows/desktop/bb736357(v=vs.85).aspx</a></p>
<p>for details.</p>
<div id="footnotes_div">
<hr>
<p><strong>Footnotes</strong></p>
<ol>
<li id="fnref1"><p>This topic was discussed in the chapter “Debugging a stand-alone <abbr title="Executable file with the extension 'exe'">EXE</abbr>”</p><a href="#fnref1" class="footnote_anchor"></a>
<li id="fnref2"><p><a href="http://aplwiki.com/PhilLast" class="external_link">http://aplwiki.com/PhilLast</a></p><a href="#fnref2" class="footnote_anchor"></a>
<li id="fnref3"><p>For details and download regarding the user commands <code>Hex2Int</code> and <code>Int2Hex</code> see <a href="http://aplwiki.com/UserCommands/Hex" class="external_link">http://aplwiki.com/UserCommands/Hex</a></p><a href="#fnref3" class="footnote_anchor"></a>
<li id="fnref4"><p>For details and download regarding the user command <code>GetMsgFrom</code> see <a href="http://aplwiki.com/UserCommands/GetMsgFrom" class="external_link">http://aplwiki.com/UserCommands/GetMsgFrom</a></p><a href="#fnref4" class="footnote_anchor"></a>
</ol>
</div>
</body>
</html>